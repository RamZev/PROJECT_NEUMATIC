{% extends 'proceso_form.html' %}
{% load static %}
{% load custom_tags %}

{% block style %}
    body {
        background-color: #f8f9fa;
    }
    .tbl-container {
        width: 100%;
        overflow-x: auto;
    }
    .tbl-fixed {
        overflow-x: scroll;
        overflow-y: scroll;
        height: fit-content;
        max-height: 60vh;
        margin-top: 0px;
        font-size: 80%;
    }
    table {
        width: 100%;
        table-layout: fixed;
    }
    table th, table td {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    table th {
        position: sticky;
        top: 0px;
    }
    .small-font {
        font-size: 0.8rem;
    }
    .formatted-number {
        display: block;
        width: 100%;
        padding: 0.375rem 0.15rem;
        text-align: right;
        background-color: #e7f5ff;
        border: 1px solid #0d6efd;
        border-radius: 0.25rem;
        font-family: monospace;
        margin: 2px 0;
        font-size: 1.1rem;
    }
{% endblock style %}

{% block maincomponent %}
<div id="layoutSidenav_content">
    <main>
        <div class="container-fluid tbl-container">
            <form method="post" id="compra-form" enctype="multipart/form-data">
                {% csrf_token %}

                <!-- Acordeón: Encabezado de Compra -->
                <div class="accordion mt-2" id="accordionCompra">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEncabezado" aria-expanded="true">
                                Encabezado de Compra
                            </button>
                        </h2>
                        <div id="collapseEncabezado" class="accordion-collapse collapse show">
                            <div class="accordion-body">
                                <div class="row">
                                    <!-- Columna Izquierda -->
                                    <div class="col-md-6">
                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label>Estatus</label>
                                            </div>
                                            <div class="col-md-9">
                                                {{ form.estatus_comprabante }}
                                            </div>
                                        </div>
                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label>Sucursal</label>
                                            </div>
                                            <div class="col-md-9">
                                                {{ form.nombre_sucursal }}
                                                {{ form.id_sucursal }}
                                            </div>
                                        </div>
                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label>Depósito</label>
                                            </div>
                                            <div class="col-md-9">
                                                {{ form.id_deposito }}
                                            </div>
                                        </div>
                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label>Comprobante</label>
                                            </div>
                                            <div class="col-md-9">
                                                {{ form.id_comprobante_compra }}
                                            </div>
                                        </div>
                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label>{{form.id_proveedor.label}}</label>
                                            </div>
                                            <div class="col-md-7">
                                                {{ form.id_proveedor }}
                                            </div>
                                            
                                            <div class="col-md-2">
                                                <a href="{% url 'proveedor_create' %}" target="_blank" class="btn btn-outline-primary btn-sm">
                                                    <i class="bi bi-building-add"></i>
                                                </a>
                                            </div>
                                        </div>
                                        
                                    </div>

                                    <!-- Columna Derecha -->
                                    <div class="col-md-6">
                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label>Fecha Emisión</label>
                                            </div>
                                            <div class="col-md-4">
                                                {{ form.fecha_comprobante }}
                                            </div>
                                            <div class="col-md-5">
                                                {{ form.condicion_compra_display }}
                                            </div>
                                        </div>
                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label>Comprobante</label>
                                            </div>
                                            <div class="col-md-2">
                                                {{ form.compro }}
                                            </div>
                                            <div class="col-md-2">
                                                {{ form.letra_comprobante }}
                                            </div>
                                            <div class="col-md-5">
                                                {{ form.numero_comprobante }}
                                            </div>
                                        </div>
                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label>Condición</label>
                                            </div>
                                            <div class="col-md-4">
                                                {{ form.condicion_comprobante }}
                                            </div>
                                            <div class="col-md-5">
                                                {{ form.documento_asociado }}
                                            </div>
                                        </div>
                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label>Fecha Registro</label>
                                            </div>
                                            <div class="col-md-4">
                                                {{ form.fecha_registro }}
                                            </div>
                                            <div class="col-md-5">
                                                <label>Fecha Vencimiento</label>
                                                {{ form.fecha_vencimiento }}
                                            </div>
                                        </div>
                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label>Email</label>
                                            </div>
                                            <div class="col-md-9">
                                                {{ form.observa_comprobante }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Botón para agregar detalle -->
                    <div class="container my-3">
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-outline-primary btn-sm me-2" id="btnAgregarDetalle">
                                Agregar Detalle
                                <i class="bi bi-file-earmark-plus"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Acordeón: Detalle de Compra -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDetalle" aria-expanded="false">
                                Detalle de la Compra
                            </button>
                        </h2>
                        <div id="collapseDetalle" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                <div class="row tbl-fixed my-2 mx-1" id="formset-container">
                                    {{ formset_detalle.management_form }}
                                    <table class="table table-striped table-hover" style="width: 100%;">
                                        <thead class="table-primary small-font">
                                            <tr>
                                                <th style="width: 10%;">Medida</th>
                                                <th style="width: 30%;">Producto</th>
                                                <th style="width: 10%;">Cantidad</th>
                                                <th style="width: 15%;">Precio</th>
                                                <th style="width: 15%;">Total</th>
                                                <th style="width: 10%;">Despacho</th>
                                                <th style="width: 10%;">Elim</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for formdet in formset_detalle %}
                                            <tr data-form-index="{{ forloop.counter0 }}">
                                                <td>
                                                    {% if formdet.instance.pk %}
                                                        {{ formdet.id_detalle_compra }}
                                                        {{ formdet.id_compra }}
                                                        {{ formdet.id_producto }}
                                                    {% endif %}
                                                    {{ formdet.medida }}
                                                </td>
                                                <td>{{ formdet.producto_venta }}</td>
                                                <td>{{ formdet.cantidad }}</td>
                                                <td>{{ formdet.precio }}</td>
                                                <td>
                                                    {{ formdet.total }}
                                                </td>
                                                <td>{{ formdet.despacho }}</td>
                                                <td>
                                                    <button type="button" class="btn btn-danger btn-sm btn-delete" data-form-index="{{ forloop.counter0 }}">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                    <input type="checkbox" name="detallecompra_set-{{ forloop.counter0 }}-DELETE" style="display: none;">
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <td colspan="100%">
                                                    <div class="row align-items-center g-2 py-2" style="background-color: #f8f9fa; border-top: 2px solid #dee2e6;">
                                                        <div class="col-md-2">
                                                            <div class="d-flex flex-column gap-2">
                                                                <button type="submit" class="btn btn-outline-success btn-sm">
                                                                    {% if is_edit %}Actualizar{% else %}Guardar{% endif %}
                                                                    <i class="bi bi-floppy"></i>
                                                                </button>
                                                                <a href="{% url 'compra_list' %}" class="btn btn-outline-secondary btn-sm">
                                                                    Cancelar
                                                                    <i class="bi bi-x-circle"></i>
                                                                </a>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-2">
                                                            <div class="text-center">
                                                                <label class="form-label mb-0 text-primary"><strong>Gravado</strong></label>
                                                                <div>
                                                                    {{ form.gravado }}
                                                                    <span class="formatted-number">{{ form.gravado.value|default:"0.00" }}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-2">
                                                            <div class="text-center">
                                                                <label class="form-label mb-0 text-primary"><strong>Exento</strong></label>
                                                                <div>
                                                                    {{ form.exento }}
                                                                    <span class="formatted-number">{{ form.exento.value|default:"0.00" }}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-2">
                                                            <div class="text-center">
                                                                <label class="form-label mb-0 text-primary"><strong>IVA</strong></label>
                                                                <div>
                                                                    {{ form.iva }}
                                                                    <span class="formatted-number">{{ form.iva.value|default:"0.00" }}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-2">
                                                            <div class="text-center">
                                                                <label class="form-label mb-0 text-primary"><strong>Total</strong></label>
                                                                <div>
                                                                    {{ form.total }}
                                                                    <span class="formatted-number">{{ form.total.value|default:"0.00" }}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </main>
</div>
{% endblock maincomponent %}

{% block modals %}
<!-- Modal para Buscar Producto -->
<div class="modal fade" id="detalleModal" tabindex="-1" aria-labelledby="detalleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="detalleModalLabel">Seleccionar Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" id="detalleForm">
                    {% csrf_token %}
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <input type="text" class="form-control form-control-sm" id="medida_producto" placeholder="Medida">
                        </div>
                        <div class="col-md-5">
                            <input type="text" class="form-control form-control-sm" id="nombre_producto" placeholder="Nombre Producto">
                        </div>
                        <div class="col-md-3">
                            <button type="submit" class="btn btn-outline-primary btn-sm">Buscar</button>
                        </div>
                    </div>
                    <div class="table-responsive" style="max-height: 30vh;">
                        <table class="table table-striped" id="tabla-resultados">
                            <thead class="table-primary">
                                <tr>
                                    <th>Medida</th>
                                    <th>Nombre</th>
                                    <th>Precio</th>
                                    <th>Stock</th>
                                    <th>Seleccionar</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="d-flex justify-content-between mt-3">
                        <button type="button" class="btn btn-outline-primary btn-sm" id="agregarDetalle">Insertar</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock modals %}

{% block script %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const formsetContainer = document.getElementById('formset-container');

    // Recalcular total de la compra
    function actualizarTotalCompra() {
        let totalGravado = 0;
        let totalExento = 0;
        let totalIva = 0;
        let totalFactura = 0;

        document.querySelectorAll('.table tbody tr:not([style*="display: none"])').forEach(row => {
            const total = parseFloat(row.querySelector('[name*="-total"]').value) || 0;
            totalFactura += total;
        });

        document.getElementById('id_gravado').value = totalGravado.toFixed(2);
        document.getElementById('id_exento').value = totalExento.toFixed(2);
        document.getElementById('id_iva').value = totalIva.toFixed(2);
        document.getElementById('id_total').value = totalFactura.toFixed(2);

        // Actualizar visualización
        ['id_gravado', 'id_exento', 'id_iva', 'id_total'].forEach(id => {
            const input = document.getElementById(id);
            const span = input.nextElementSibling;
            if (span && span.classList.contains('formatted-number')) {
                span.textContent = parseFloat(input.value).toLocaleString('es-AR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            }
        });
    }

    // Recalcular fila de detalle
    function recalcularFila(row) {
        const cantidad = parseFloat(row.querySelector('[name*="-cantidad"]').value) || 0;
        const precio = parseFloat(row.querySelector('[name*="-precio"]').value) || 0;
        const total = cantidad * precio;

        row.querySelector('[name*="-total"]').value = total.toFixed(2);
        actualizarTotalCompra();
    }

    // Evento para cambios en cantidad o precio
    formsetContainer.addEventListener('input', function (event) {
        if (event.target.matches('[name*="-cantidad"], [name*="-precio"]')) {
            const row = event.target.closest('tr');
            recalcularFila(row);
        }
    });

    // Eliminar fila
    document.addEventListener('click', function (event) {
        if (event.target.closest('.btn-delete')) {
            const row = event.target.closest('tr');
            const deleteInput = row.querySelector('input[name$="-DELETE"]');
            if (confirm('¿Eliminar este ítem?')) {
                if (deleteInput) {
                    deleteInput.checked = true;
                    row.style.display = 'none';
                    actualizarTotalCompra();
                }
            }
        }
    });

    // Agregar nuevo detalle
    document.getElementById('btnAgregarDetalle').addEventListener('click', function() {
        if (!document.getElementById('id_id_proveedor')?.value) {
            alert('Primero seleccione un proveedor');
            return;
        }
        const modal = new bootstrap.Modal(document.getElementById('detalleModal'));
        modal.show();
    });

    // Buscar productos
    document.getElementById('detalleForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const medida = document.getElementById('medida_producto').value;
        const nombre = document.getElementById('nombre_producto').value;

        fetch(`/ventas/buscar/producto/?medida=${medida}&nombre=${nombre}`)
            .then(response => response.json())
            .then(data => {
                const tbody = document.querySelector('#tabla-resultados tbody');
                tbody.innerHTML = '';
                data.forEach(producto => {
                    const row = `
                    <tr>
                        <td>${producto.medida}</td>
                        <td>${producto.nombre}</td>
                        <td class="text-end">${parseFloat(producto.precio).toFixed(2)}</td>
                        <td class="text-end">${producto.stock}</td>
                        <td>
                            <input type="checkbox" class="seleccionar-producto"
                                data-id="${producto.id}"
                                data-medida="${producto.medida}"
                                data-nombre="${producto.nombre}"
                                data-precio="${producto.precio}">
                        </td>
                    </tr>`;
                    tbody.insertAdjacentHTML('beforeend', row);
                });
            });
    });

    // Insertar productos seleccionados
    document.getElementById('agregarDetalle').addEventListener('click', function() {
        const checkboxes = document.querySelectorAll('.seleccionar-producto:checked');
        if (checkboxes.length === 0) {
            alert('Seleccione al menos un producto');
            return;
        }

        checkboxes.forEach(checkbox => {
            const currentIndex = formsetContainer.querySelectorAll('.table tbody tr').length;
            const producto = {
                id: checkbox.dataset.id,
                medida: checkbox.dataset.medida,
                nombre: checkbox.dataset.nombre,
                precio: parseFloat(checkbox.dataset.precio),
                cantidad: 1
            };

            const total = (producto.cantidad * producto.precio).toFixed(2);

            const newRow = `
            <tr data-form-index="${currentIndex}">
                <input type="hidden" name="detallecompra_set-${currentIndex}-id_detalle_compra">
                <input type="hidden" name="detallecompra_set-${currentIndex}-id_compra">
                <input type="hidden" name="detallecompra_set-${currentIndex}-id_producto" value="${producto.id}">
                <td>${producto.medida}</td>
                <td>
                    <input type="text" name="detallecompra_set-${currentIndex}-producto_venta"
                        class="form-control form-control-sm" value="${producto.nombre}" readonly>
                </td>
                <td>
                    <input type="number" name="detallecompra_set-${currentIndex}-cantidad"
                        class="form-control form-control-sm text-end" value="${producto.cantidad}" min="0.01" step="0.01" required>
                </td>
                <td>
                    <input type="number" name="detallecompra_set-${currentIndex}-precio"
                        class="form-control form-control-sm text-end" value="${producto.precio}" min="0.01" step="0.01" required>
                </td>
                <td>
                    <input type="number" name="detallecompra_set-${currentIndex}-total"
                        class="form-control form-control-sm text-end" value="${total}" readonly>
                </td>
                <td>
                    <input type="text" name="detallecompra_set-${currentIndex}-despacho"
                        class="form-control form-control-sm" maxlength="16">
                </td>
                <td>
                    <button type="button" class="btn btn-danger btn-sm btn-delete" data-form-index="${currentIndex}">
                        <i class="bi bi-trash"></i>
                    </button>
                    <input type="checkbox" name="detallecompra_set-${currentIndex}-DELETE" style="display: none;">
                </td>
            </tr>`;

            formsetContainer.querySelector('.table tbody').insertAdjacentHTML('beforeend', newRow);
            recalcularFila(formsetContainer.querySelector('.table tbody tr:last-child'));
        });

        checkboxes.forEach(cb => cb.checked = false);
        bootstrap.Modal.getInstance(document.getElementById('detalleModal')).hide();
    });

    // Inicializar totales si hay datos
    if (formsetContainer.querySelectorAll('.table tbody tr').length > 0) {
        actualizarTotalCompra();
    }
});
</script>
{% endblock script %}