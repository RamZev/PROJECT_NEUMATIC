{% extends 'proceso_form.html' %}
{% load static %}
{% load custom_tags %}

{% block style %}
    body {
        background-color: #f8f9fa;
    }
    .tbl-container {
        width: 100%;
        overflow-x: auto;
    }
    .tbl-fixed {
        overflow-x: scroll;
        overflow-y: scroll;
        height: fit-content;
        max-height: 60vh;
        margin-top: 0px;
        font-size: 80%;
    }
    table {
        width: 100%;
        table-layout: fixed;
    }
    table th, table td {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    table th {
        position: sticky;
        top: 0px;
    }
    .small-font {
        font-size: 0.8rem;
    }
    .formatted-number {
        display: block;
        width: 100%;
        padding: 0.375rem 0.15rem;
        text-align: right;
        background-color: #e7f5ff;
        border: 1px solid #0d6efd;
        border-radius: 0.25rem;
        font-family: monospace;
        margin: 2px 0;
        font-size: 1.1rem;
    }
{% endblock style %}

{% block maincomponent %}
<div id="layoutSidenav_content">
    <main>
         <!-- DIV OCULTO CON DATOS DE COMPROBANTES -->
        <div id="comprobante-codigos-data" data-codigos='{{ comprobante_codigos|safe }}'></div>


        <div class="container-fluid tbl-container">
            <form method="post" id="compra-form" enctype="multipart/form-data">
                {% csrf_token %}

                <!-- Acordeón: Encabezado de Compra -->
                <div class="accordion mt-2" id="accordionCompra">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEncabezado" aria-expanded="true">
                                Encabezado de Compra
                            </button>
                        </h2>
                        <div id="collapseEncabezado" class="accordion-collapse collapse show">
                            <div class="accordion-body">
                                <div class="row">
                                    <!-- Columna Izquierda -->
                                    <div class="col-md-6">
                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label>Estatus</label>
                                            </div>
                                            <div class="col-md-9">
                                                {{ form.estatus_comprabante }}
                                            </div>
                                        </div>
                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label>Sucursal</label>
                                            </div>
                                            <div class="col-md-9">
                                                {{ form.nombre_sucursal }}
                                                {{ form.id_sucursal }}
                                            </div>
                                        </div>
                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label>Depósito</label>
                                            </div>
                                            <div class="col-md-9">
                                                {{ form.id_deposito }}
                                            </div>
                                        </div>
                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label>Comprobante</label>
                                            </div>
                                            <div class="col-md-9">
                                                {{ form.id_comprobante_compra }}
                                            </div>
                                        </div>
                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label>{{form.id_proveedor.label}}</label>
                                            </div>
                                            <div class="col-md-7">
                                                {{ form.id_proveedor }}
                                            </div>
                                            
                                            <div class="col-md-2">
                                                <a href="{% url 'proveedor_create' %}" target="_blank" class="btn btn-outline-primary btn-sm">
                                                    <i class="bi bi-building-add"></i>
                                                </a>
                                            </div>
                                        </div>
                                        
                                    </div>

                                    <!-- Columna Derecha -->
                                    <div class="col-md-6">
                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label>Fecha Emisión</label>
                                            </div>
                                            <div class="col-md-4">
                                                {{ form.fecha_comprobante }}
                                            </div>
                                            <div class="col-md-5">
                                                {{ form.condicion_compra_display }}
                                            </div>
                                        </div>
                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label>Comprobante</label>
                                            </div>
                                            <div class="col-md-2">
                                                {{ form.compro }}
                                            </div>
                                            <div class="col-md-2">
                                                {{ form.letra_comprobante }}
                                            </div>
                                            <div class="col-md-5">
                                                {{ form.numero_comprobante }}
                                            </div>
                                        </div>
                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label>Condición</label>
                                            </div>
                                            <div class="col-md-4">
                                                {{ form.condicion_comprobante }}
                                            </div>
                                            <div class="col-md-5">
                                                {{ form.documento_asociado }}
                                            </div>
                                        </div>
                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label>Fecha Registro</label>
                                            </div>
                                            <div class="col-md-4">
                                                {{ form.fecha_registro }}
                                            </div>
                                            
                                        </div>
                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label>Vencimiento</label>
                                            </div>
                                            <div class="col-md-4">
                                                {{ form.fecha_registro }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Botón para agregar detalle -->
                    <div class="container my-3">
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-outline-primary btn-sm me-2" id="btnAgregarDetalle">
                                Agregar Detalle
                                <i class="bi bi-file-earmark-plus"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Acordeón: Detalle de Compra -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDetalle" aria-expanded="false">
                                Detalle de la Compra
                            </button>
                        </h2>
                        <div id="collapseDetalle" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                <div class="row tbl-fixed my-2 mx-1" id="formset-container">
                                    {{ formset_detalle.management_form }}
                                    
                                    <table class="detalle-form table table-striped table-hover table-responsive" style="width: 100%;">
                                        <thead class="table-primary small-font">
                                            <tr>
                                                <th style="width: 10%;">Medida</th>
                                                <th style="width: 30%;">Producto</th>
                                                <th style="width: 10%;">Despacho</th>
                                                <th style="width: 10%;">Cantidad</th>
                                                <th style="width: 15%;">Precio</th>
                                                <th style="width: 15%;">Total</th>
                                                <th style="width: 10%;">Elim</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for formdet in formset_detalle %}
                                            <tr data-form-index="{{ forloop.counter0 }}">
                                                <td>
                                                    {% if formdet.instance.pk %}
                                                        {{ formdet.id_detalle_compra }}
                                                        {{ formdet.id_compra }}
                                                        {{ formdet.id_producto }}
                                                    {% endif %}
                                                    {{ formdet.medida }}
                                                </td>
                                                <td>{{ formdet.producto_venta }}</td>
                                                <td>{{ formdet.despacho }}</td>  <!-- Despacho ahora va aquí -->
                                                <td>{{ formdet.cantidad }}</td>
                                                <td>{{ formdet.precio }}</td>
                                                <td>{{ formdet.total }}</td>
                                                <td>
                                                    <button type="button" class="btn btn-danger btn-sm btn-delete" data-form-index="{{ forloop.counter0 }}">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                    <input type="checkbox" name="detallecompra_set-{{ forloop.counter0 }}-DELETE" style="display: none;">
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <td colspan="100%">
                                                    <div class="row align-items-center g-2 py-2" style="background-color: #f8f9fa; border-top: 2px solid #dee2e6;">
                                                        <div class="col-md-2">
                                                            <div class="d-flex flex-column gap-2">
                                                                <button type="submit" class="btn btn-outline-success btn-sm">
                                                                    {% if is_edit %}Actualizar{% else %}Guardar{% endif %}
                                                                    <i class="bi bi-floppy"></i>
                                                                </button>
                                                                <a href="{% url 'compra_list' %}" class="btn btn-outline-secondary btn-sm">
                                                                    Cancelar
                                                                    <i class="bi bi-x-circle"></i>
                                                                </a>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-2">
                                                            <div class="text-center">
                                                                <label class="form-label mb-0 text-primary"><strong>Gravado</strong></label>
                                                                <div>
                                                                    {{ form.gravado }}
                                                                    <span class="formatted-number">{{ form.gravado.value|default:"0.00" }}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-2">
                                                            <div class="text-center">
                                                                <label class="form-label mb-0 text-primary"><strong>Exento</strong></label>
                                                                <div>
                                                                    {{ form.exento }}
                                                                    <span class="formatted-number">{{ form.exento.value|default:"0.00" }}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-2">
                                                            <div class="text-center">
                                                                <label class="form-label mb-0 text-primary"><strong>IVA</strong></label>
                                                                <div>
                                                                    {{ form.iva }}
                                                                    <span class="formatted-number">{{ form.iva.value|default:"0.00" }}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-2">
                                                            <div class="text-center">
                                                                <label class="form-label mb-0 text-primary"><strong>Total</strong></label>
                                                                <div>
                                                                    {{ form.total }}
                                                                    <span class="formatted-number">{{ form.total.value|default:"0.00" }}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
            <div>
            Mensaes de error: {{ message}}
            </div>

        </div>
    </main>
</div>
{% endblock maincomponent %}

{% block modals %}
    <!-- Modal para Buscar Producto -->
    <div class="modal fade" id="detalleModal" tabindex="-1" aria-labelledby="detalleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl" style="max-width: 90%;">
            <div class="modal-content">
                <div class="modal-header text-dark bg-primary bg-opacity-25 py-2">
                    <h5 class="modal-title fs-6" id="detalleModalLabel">Productos**</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="post" id="detalleForm">
                        {% csrf_token %}
                        
                        <!-- Filtros de búsqueda -->
                        <div class="row mb-3">
                            <div class="col-md-12 d-flex justify-content-start align-items-center flex-wrap">
                                <label class="me-3 fw-bold">Filtrar por:</label>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="filtro_marca" id="filtro_primeras" value="primeras" checked>
                                    <label class="form-check-label" for="filtro_primeras">Primeras Marcas</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="filtro_marca" id="filtro_otras" value="otras">
                                    <label class="form-check-label" for="filtro_otras">Otras Marcas</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="filtro_marca" id="filtro_stock" value="stock">
                                    <label class="form-check-label" for="filtro_stock">Solo en Stock</label>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-3">
                                <input type="text" class="form-control form-control-sm border border-primary" id="medida_producto" placeholder="Medida Producto">
                            </div>
                            <div class="col-md-4">
                                <input type="text" class="form-control form-control-sm border border-primary" id="nombre_producto" placeholder="Nombre Producto">
                            </div>
                            <div class="col-md-3">
                                <input type="text" class="form-control form-control-sm border border-primary" id="cai_producto" placeholder="CAI Producto">
                            </div>
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-outline-primary btn-sm me-2">
                                    Buscar
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Tabla de resultados -->
                        <div class="table-responsive tbl-fixed" style="max-height: 30vh; overflow-y: auto;">
                            <table class="table table-striped small-text" id="tabla-resultados">
                                <thead class="table-primary fs-7">
                                    <th style="width: 12%;">Marca</th>
                                    <th style="width: 12%;">Medida</th>
                                    <th style="width: 10%;">CAI</th>
                                    <th style="width: 25%;">Nombre</th>
                                    <th style="width: 10%;">Precio</th>
                                    <th style="width: 8%;">Stock</th>
                                    <th style="width: 8%;">Mínimo</th>
                                    <th style="width: 8%;">Detalle</th>
                                    <th style="width: 8%;">...</th>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>

                        <!-- Botones de acción -->
                        <div class="d-flex align-items-center mt-3">
                            <h6 id="titulo-producto" class="mb-0 me-auto" style="line-height: 1.5;">Título del Producto</h6>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-outline-primary btn-sm" id="agregarDetalle">Insertar</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal" id="cancelarDetalle">Cancelar</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock modals %}

{% block script %}
    {{ block.super }}

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const formsetContainer = document.getElementById('formset-container');

        // DEBUG: Función para verificar nombres de campos
        function debugNombresCampos() {
            console.log('=== DEBUG NOMBRES CAMPOS ===');
            const filas = document.querySelectorAll('.table tbody tr');
            filas.forEach((fila, index) => {
                const inputs = fila.querySelectorAll('input');
                console.log(`Fila ${index}:`);
                inputs.forEach(input => {
                    console.log(`  - ${input.name}: ${input.value} (type: ${input.type})`);
                });
            });
        }

        // 1. FUNCIÓN PARA ACTUALIZAR TOTALES DE COMPRA (CORREGIDA)
        function actualizarTotalCompra() {
            let totalFactura = 0;

            console.log('=== ACTUALIZANDO TOTALES ===');
            
            // Sumar todos los totales de las filas visibles
            document.querySelectorAll('.table tbody tr:not([style*="display: none"])').forEach((row, index) => {
                // Buscar el campo total de forma más específica
                const totalInput = row.querySelector('input[name*="-total"]');
                if (totalInput) {
                    const total = parseFloat(totalInput.value) || 0;
                    totalFactura += total;
                    console.log(`Fila ${index}: total = ${total}`);
                } else {
                    console.log(`Fila ${index}: NO se encontró campo total`);
                }
            });

            console.log('Total calculado:', totalFactura);

            // Actualizar campo total del formulario principal
            const totalInput = document.getElementById('id_total');
            if (totalInput) {
                totalInput.value = totalFactura.toFixed(2);
                console.log('Campo id_total actualizado a:', totalFactura.toFixed(2));
            }

            // Actualizar visualización formateada
            actualizarVisualizacionTotales();
            
            // Debug final
            debugNombresCampos();
        }

        // 2. FUNCIÓN PARA FORMATEAR NÚMEROS
        function actualizarVisualizacionTotales() {
            const campos = ['id_gravado', 'id_exento', 'id_iva', 'id_total'];
            
            campos.forEach(id => {
                const input = document.getElementById(id);
                if (!input) {
                    console.log(`Campo ${id} no encontrado`);
                    return;
                }
                
                const span = input.nextElementSibling;
                if (!span || !span.classList.contains('formatted-number')) {
                    console.log(`Span para ${id} no encontrado`);
                    return;
                }
                
                const valor = parseFloat(input.value) || 0;
                span.textContent = valor.toLocaleString('es-AR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            });
        }

        // 3. RECALCULAR FILA INDIVIDUAL (CORREGIDA)
        function recalcularFila(row) {
            console.log('Recalculando fila...');
            
            const cantidadInput = row.querySelector('input[name*="-cantidad"]');
            const precioInput = row.querySelector('input[name*="-precio"]');
            const totalInput = row.querySelector('input[name*="-total"]');
            
            if (!cantidadInput || !precioInput || !totalInput) {
                console.log('❌ Campos no encontrados en fila:', {
                    cantidad: !!cantidadInput,
                    precio: !!precioInput,
                    total: !!totalInput
                });
                return;
            }
            
            const cantidad = parseFloat(cantidadInput.value) || 0;
            const precio = parseFloat(precioInput.value) || 0;
            const total = cantidad * precio;

            console.log(`Cálculo: ${cantidad} × ${precio} = ${total}`);
            
            totalInput.value = total.toFixed(2);
            actualizarTotalCompra();
        }

        // 4. EVENTO PARA CAMBIOS EN CANTIDAD O PRECIO
        formsetContainer.addEventListener('input', function (event) {
            const target = event.target;
            if (target.matches('input[name*="-cantidad"], input[name*="-precio"]')) {
                const row = target.closest('tr');
                if (row) {
                    console.log('Cambio detectado en:', target.name);
                    recalcularFila(row);
                }
            }
        });

        // 5. ELIMINAR FILA
        document.addEventListener('click', function (event) {
            if (event.target.closest('.btn-delete')) {
                const row = event.target.closest('tr');
                const deleteInput = row.querySelector('input[name$="-DELETE"]');
                
                if (confirm('¿Está seguro de eliminar este ítem de la compra?')) {
                    if (deleteInput) {
                        deleteInput.checked = true;
                        row.style.display = 'none';
                        actualizarTotalCompra();
                        actualizarContadorFormsets();
                    }
                }
            }
        });

        // 6. ACTUALIZAR CONTADOR DE FORMSETS
        function actualizarContadorFormsets() {
            const allRows = document.querySelectorAll('.detalle-form tbody tr').length;
            document.getElementById('id_detallecompra_set-TOTAL_FORMS').value = allRows;
        }

        // 7. ABRIR MODAL DE PRODUCTOS
        document.getElementById('btnAgregarDetalle').addEventListener('click', function() {
            if (!document.getElementById('id_id_proveedor')?.value) {
                alert('Primero seleccione un proveedor');
                return;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('detalleModal'));
            modal.show();
        });

        // 8. BUSCAR PRODUCTOS 
        document.getElementById('detalleForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const medidaProducto = document.getElementById('medida_producto').value;
            const nombreProducto = document.getElementById('nombre_producto').value;
            const caiProducto = document.getElementById('cai_producto').value;

            const filtroMarcaElement = document.querySelector('input[name="filtro_marca"]:checked');
            const filtroMarca = filtroMarcaElement ? filtroMarcaElement.value : '';

            const url = new URL('/ventas/buscar/producto/', window.location.origin);
            url.searchParams.append('medida', medidaProducto);
            url.searchParams.append('nombre', nombreProducto);
            url.searchParams.append('cai', caiProducto);
            url.searchParams.append('filtro_marca', filtroMarca);

            fetch(url, {
                method: 'GET',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                const tbody = document.querySelector('#tabla-resultados tbody');
                tbody.innerHTML = '';

                const formateadorPrecio = new Intl.NumberFormat('es-ES', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2,
                });
                
                data.forEach(producto => {
                    const fila = `
                        <tr>
                            <td>${producto.marca}</td>
                            <td>${producto.medida}</td>
                            <td>${producto.cai || 'N/A'}</td>
                            <td>${producto.nombre}</td>
                            <td class="text-end"><strong>${formateadorPrecio.format(producto.precio)}</strong></td>
                            <td class="text-end">${producto.stock}</td>
                            <td class="text-end">${producto.minimo}</td>
                            <td class="text-center">
                                <button type="button" class="btn btn-info btn-sm actualizar-detalle" 
                                    data-id="${producto.id}" 
                                    data-nombre="${producto.nombre}"
                                    data-cai="${producto.cai || 'N/A'}">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </td>
                            <td>
                                <input type="checkbox" class="seleccionar-producto"
                                    data-id="${producto.id}" 
                                    data-medida="${producto.medida}"
                                    data-nombre="${producto.nombre}"
                                    data-precio="${producto.precio}">
                            </td>
                        </tr>`;
                    tbody.insertAdjacentHTML('beforeend', fila);
                });

                document.querySelectorAll('.actualizar-detalle').forEach(button => {
                    button.addEventListener('click', function () {
                        document.querySelectorAll('.actualizar-detalle').forEach(btn => {
                            btn.classList.remove('btn-success');
                            btn.classList.add('btn-info');
                        });
                        this.classList.remove('btn-info');
                        this.classList.add('btn-success');
                    });
                });
            })
            .catch(error => console.error('Error:', error));
        });

        // 9. INSERTAR PRODUCTOS SELECCIONADOS (CORREGIDO)
        document.getElementById('agregarDetalle').addEventListener('click', function() {
            const checkboxes = document.querySelectorAll('.seleccionar-producto:checked');
            
            if (checkboxes.length === 0) {
                alert('Seleccione al menos un producto');
                return;
            }

            console.log('Insertando', checkboxes.length, 'productos...');

            checkboxes.forEach(checkbox => {
                const currentIndex = formsetContainer.querySelectorAll('.table tbody tr').length;
                const producto = {
                    id: checkbox.dataset.id,
                    medida: checkbox.dataset.medida,
                    nombre: checkbox.dataset.nombre,
                    precio: parseFloat(checkbox.dataset.precio),
                    cantidad: 1.00
                };

                const total = (producto.cantidad * producto.precio).toFixed(2);

                console.log(`Insertando producto ${producto.nombre} en índice ${currentIndex}`);

                const newRow = `
                <tr data-form-index="${currentIndex}" class="small-font">
                    <!-- Campos ocultos -->
                    <input type="hidden" name="detallecompra_set-${currentIndex}-id_detalle_compra">
                    <input type="hidden" name="detallecompra_set-${currentIndex}-id_compra">
                    <input type="hidden" name="detallecompra_set-${currentIndex}-id_producto" value="${producto.id}">
                    
                    <!-- Campos visibles -->
                    <td>${producto.medida}</td>
                    <td>
                        <input type="text" name="detallecompra_set-${currentIndex}-producto_venta"
                            class="form-control form-control-sm border border-primary" 
                            value="${producto.nombre}" readonly>
                    </td>
                    <td>
                        <input type="text" name="detallecompra_set-${currentIndex}-despacho"
                            class="form-control form-control-sm border border-primary" 
                            maxlength="16" placeholder="Despacho">
                    </td>
                    <td>
                        <input type="number" name="detallecompra_set-${currentIndex}-cantidad"
                            class="form-control form-control-sm border border-primary text-end" 
                            value="${producto.cantidad}" min="0.01" step="0.01" required>
                    </td>
                    <td>
                        <input type="number" name="detallecompra_set-${currentIndex}-precio"
                            class="form-control form-control-sm border border-primary text-end" 
                            value="${producto.precio.toFixed(2)}" min="0.01" step="0.01" required>
                    </td>
                    <td>
                        <input type="number" name="detallecompra_set-${currentIndex}-total"
                            class="form-control form-control-sm border border-primary text-end" 
                            value="${total}" readonly>
                    </td>
                    <td>
                        <button type="button" class="btn btn-danger btn-sm btn-delete" data-form-index="${currentIndex}">
                            <i class="bi bi-trash"></i>
                        </button>
                        <input type="checkbox" name="detallecompra_set-${currentIndex}-DELETE" style="display: none;">
                    </td>
                </tr>`;

                formsetContainer.querySelector('.table tbody').insertAdjacentHTML('beforeend', newRow);
                
                // Recalcular inmediatamente después de insertar
                setTimeout(() => {
                    const nuevaFila = formsetContainer.querySelector('.table tbody tr:last-child');
                    if (nuevaFila) {
                        recalcularFila(nuevaFila);
                    }
                }, 10);
            });

            // Limpiar y cerrar
            checkboxes.forEach(cb => cb.checked = false);
            bootstrap.Modal.getInstance(document.getElementById('detalleModal')).hide();
            
            // Actualizar contador (solo una vez)
            actualizarContadorFormsets();
            
            // Ajustar acordeones
            setTimeout(() => {
                const accordionDetalle = document.getElementById('collapseDetalle');
                const btnDetalle = document.querySelector('[data-bs-target="#collapseDetalle"]');
                
                if (accordionDetalle && !accordionDetalle.classList.contains('show')) {
                    new bootstrap.Collapse(accordionDetalle, { show: true });
                    btnDetalle.classList.remove('collapsed');
                }
            }, 10);
        });

        // 10. CONTROL DE INPUTS EN MODAL
        const medidaInput = document.getElementById('medida_producto');
        const nombreInput = document.getElementById('nombre_producto');
        const caiInput = document.getElementById('cai_producto');
        const inputs = [medidaInput, nombreInput, caiInput];
        
        function manageInputs() {
            const inputWithValue = inputs.find(input => input.value.trim() !== '');
            if (inputWithValue) {
                inputs.forEach(input => {
                    if (input !== inputWithValue) {
                        input.disabled = true;
                        input.value = '';
                    }
                });
            } else {
                inputs.forEach(input => input.disabled = false);
            }
        }
        
        inputs.forEach(input => {
            input.addEventListener('input', manageInputs);
            input.addEventListener('blur', manageInputs);
            input.addEventListener('keydown', function(e) {
                if ((e.key === 'Backspace' || e.key === 'Delete') && this.value === '') {
                    inputs.forEach(i => i.disabled = false);
                }
            });
        });

        ////
        // 11. MANEJO DEL CAMBIO DE COMPROBANTE DE COMPRA (VERSIÓN SIMPLIFICADA)
        const comprobanteSelect = document.getElementById('id_id_comprobante_compra');
        const comproInput = document.getElementById('id_compro');
        const letraInput = document.getElementById('id_letra_comprobante');
        const numeroInput = document.getElementById('id_numero_comprobante');

        // Obtener datos del div oculto
        const comprobanteCodigosElement = document.getElementById('comprobante-codigos-data');
        const comprobanteCodigos = comprobanteCodigosElement ? 
            JSON.parse(comprobanteCodigosElement.dataset.codigos) : {};

        console.log('Comprobantes cargados:', comprobanteCodigos);

        function actualizarDatosComprobante() {
            const comprobanteId = comprobanteSelect.value;
            
            if (!comprobanteId) {
                // Limpiar campos si no hay comprobante seleccionado
                comproInput.value = '';
                letraInput.value = '';
                return;
            }

            // Obtener código del comprobante seleccionado
            const codigo = comprobanteCodigos[comprobanteId] || '';
            comproInput.value = codigo;

            // Habilitar campos de letra y número
            letraInput.value = "R";
            letraInput.readOnly = false;
            numeroInput.readOnly = false;

            console.log(`Comprobante seleccionado: ${comprobanteId}, Código: ${codigo}`);
        }

        if (comprobanteSelect) {
            // Asignar el event listener
            comprobanteSelect.addEventListener('change', actualizarDatosComprobante);
            
            // Ejecutar al cargar si ya hay un valor seleccionado
            if (comprobanteSelect.value) {
                actualizarDatosComprobante();
            }
        }
        ////

        // Inicializar
        manageInputs();
        
        // Inicializar totales si hay filas existentes
        setTimeout(() => {
            if (formsetContainer.querySelectorAll('.table tbody tr').length > 0) {
                console.log('Inicializando totales con filas existentes...');
                actualizarTotalCompra();
            }
        }, 100);
    });
    </script>
{% endblock script %}