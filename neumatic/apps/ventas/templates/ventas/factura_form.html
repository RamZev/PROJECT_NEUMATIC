{% extends 'proceso_form.html' %}

{% load static %}

{% block style %}
    body {
        background-color: rgb(0, 204, 255);
    }

    .tbl-container {
        width: 100%;
        overflow-x: auto;
    }
        
    .tbl-fixed {
        overflow-x: scroll;
        overflow-y: scroll;
        height: fit-content;
        max-height: 60vh;
        margin-top: 0px;
        font-size: 80%;
    }
    table {
        width: 100%; /* Forzar la tabla a ocupar el 100% del contenedor */
        table-layout: fixed; /* Fijar el ancho de las columnas */
    }

    table th, table td {
        overflow: hidden; /* Prevenir que el contenido haga que la tabla se expanda */
        text-overflow: ellipsis; /* Mostrar puntos suspensivos si el contenido es demasiado largo */
        white-space: nowrap; /* Prevenir que el texto se divida en varias líneas */
    }

    table th {
        position: sticky;
        top: 0px;
    }

    /* Additional styling for inputs */
    .table .form-control {
        width: 100%; /* Ensure input fields take full width of their columns */
    }

    .small-font {
        transform: scale(1); /* Escala todo al 80% */
        transform-origin: top left; /* Mantiene la esquina superior izquierda como punto de origen */
    }

    .detalle-form {
        width: 100%;
        table-layout: fixed; /* Asegura que las columnas se distribuyan uniformemente */
    }
    
    .detalle-form thead,
    .detalle-form tbody {
        width: 100%;
    }
    
    .detalle-form th,
    .detalle-form td {
        width: 100%;
        box-sizing: border-box; /* Para incluir padding y borders en el ancho total */
    }

    
    .readonly-select {
        background-color: #f0f0f0;
        border-color: #ccc;
        color: #555;
        cursor: not-allowed;
    }
       
    
{% endblock style %}

{% block maincomponent %}

    {% block principalcomponent %}
    <div id="layoutSidenav_content">
		<main>
            <!-- Elemento HTML para almacenar el valor de is_edit -->
            <div id="modo-edicion" data-is-edit="{{ is_edit|yesno:'true,false' }}"></div>

            <div class="container-fluid tbl-container">
                <!-- Formulario Encabezado Detalle - Inicio -->
                <form method="post" id="factura-form" enctype="multipart/form-data">
                    {% csrf_token %}

                    <div class="accordion mt-2" id="accordionPanelsStayOpenExample">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseOne" aria-expanded="true" aria-controls="panelsStayOpen-collapseOne">
                                Comprobante de Venta
                            </button>
                            </h2>
                            <div id="panelsStayOpen-collapseOne" class="accordion-collapse collapse show">
                            <div class="accordion-body">
                                <!--  Encabezado de Factura- Inicio -->
                                <div class="row">
                                    <!-- sector izquierdo del encabezado start -->
                                    <div class="col-md-6">
                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label for="{{ form.estatus_comprobante.id_for_label }}">Estatus</label>
                                            </div>

                                            <div class="col-md-5">
                                                {{ form.estatus_comprobante }}
                                            </div>
                                        </div>

                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label for="{{ form.id_sucursal.id_for_label }}">Sucursal</label>
                                            </div>
                                            
                                            <div class="col-md-5">
                                                {{ form.nombre_sucursal }}
                                                {{ form.id_sucursal }}
                                            </div>

                                            <div class="col-md-4">
                                                {{ form.punto_venta }}
                                                {{ form.id_punto_venta }}
                                            </div>
                                        </div>

                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label for="{{ form.id_deposito.id_for_label }}">Depósito</label>
                                            </div>

                                            <div class="col-md-9">
                                                {{ form.id_deposito }}
                                            </div>
                                        </div>

                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label for="{{ form.id_comprobante_venta.id_for_label }}">Comprobante</label>
                                            </div>                                            
                                            
                                            <div class="col-md-9">
                                                {{ form.id_comprobante_venta }}
                                            </div>
                                        </div>

                                        <div class="row my-1">
                                            <!-- Campo de Autocompletado para Buscar Cliente -->
                                            <div class="col-md-3">
                                                <label for="{{ form.buscar_cliente.id_for_label }}">Buscar Cliente</label>
                                            </div>
                                        
                                            <div class="col-md-6">
                                                {{ form.buscar_cliente }}
                                            </div>

                                            <div class="col-md-3 d-flex justify-content-end">
                                                <button type="button" class="btn btn-outline-primary btn-sm me-2 h-75" title="Validar" id="validarBtn" disabled>
                                                    <i class="bi bi-card-checklist"></i>
                                                </button>

                                                <button type="button" class="btn btn-outline-primary btn-sm me-2 h-75" title="Listar" data-bs-toggle="modal" data-bs-target="#agendaModal" id="listar_agenda" disabled>
                                                    <i class="bi bi-card-list"></i>
                                                </button>
                                                {% comment %} <button type="button" class="btn btn-outline-primary btn-sm me-2" id="listarBtn">Listar</button> {% endcomment %}
                                                
                                                <a href="{% url 'cliente_create' %}" target="_blank" title="Crear Cliente"
                                                class="btn btn-outline-primary btn-sm me-2  h-75 d-flex align-items-center text-decoration-none">
                                                    <i class="bi bi-building-add"></i>
                                                </a>
                                                
                                            </div>
                                        </div>

                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label for="{{ form.id_cliente.id_for_label }}">ID Cliente</label>
                                            </div>

                                            <div class="col-md-3">
                                                {{ form.id_cliente }}
                                            </div>

                                            <div class="col-md-2">
                                                <label for="{{ form.cuit.id_for_label }}">CUIT</label>
                                            </div>

                                            <div class="col-md-4">
                                                {{ form.cuit }}
                                            </div>
                                        </div>

                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label for="{{ form.nombre_factura.id_for_label }}">Nombre</label>
                                            </div>
                                        
                                            <div class="col-md-9">
                                                {{ form.nombre_factura }}
                                            </div>
                                        </div>

                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label for="{{ form.domicilio_factura.id_for_label }}">Domicilio</label>
                                            </div>
                                        
                                            <div class="col-md-9">
                                                {{ form.domicilio_factura }}
                                                
                                            </div>
                                        </div>
                                        
                                    </div>
                                    <!-- sector izquierdo del encabezado end -->
                                    

                                    <!-- sector derecho del encabezado start -->
                                    <div class="col-md-6">
                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label for="{{ form.fecha_comprobante.id_for_label }}">Fecha</label>
                                            </div>
                                            
                                            <div class="col-md-4">
                                                {{ form.fecha_comprobante }}
                                            </div>

                                            <div class="col-md-5">
                                                {{ form.cliente_vip }}
                                            </div>

                                        </div>
                                        
                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label for="{{ form.compro.id_for_label }}">Comprobante</label>
                                            </div>
                                            
                                            <div class="col-md-2">
                                                {{ form.compro }}

                                            </div>
                                            
                                            <div class="col-md-2">
                                                {{ form.letra_comprobante }}

                                            </div>

                                            <div class="col-md-5">
                                                {{ form.numero_comprobante }}

                                            </div>
                                        </div>

                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label for="{{ form.remito.id_for_label }}">Remito</label>
                                            </div>

                                            <div class="col-md-4">
                                                {{ form.remito }}
                                            </div>

                                            <div class="col-md-2">
                                                {{ form.discrimina_iva }}
                                                <label class="form-check-label" for="{{ form.discrimina_iva.id_for_label }}">
                                                    DIVA
                                                </label>
                                            </div>

                                            <div class="col-md-3">
                                                {{ form.es_remito }}
                                                <label class="form-check-label" for="{{ form.es_remito.id_for_label }}">
                                                    Remito
                                                </label>
                                            </div>
                                            
                                        </div>
                                        
                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label for="id_vendedor_factura">Vendedor</label>
                                            </div>
                                            
                                            <div class="col-md-7">
                                                {{ form.vendedor_factura }}
                                                {{ form.id_vendedor }}
                                            </div>

                                            <div class="col-md-2">
                                                {{ form.tipo_venta }}
                                            </div>
                                        </div>
                                        
                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label for="{{ form.condicion_comprobante.id_for_label }}">Condición</label>
                                            </div>

                                            <div class="col-md-4">
                                                {{ form.condicion_comprobante }}
                                            </div>

                                            <div class="col-md-4">
                                                {{ form.no_estadist }}
                                                <label class="form-check-label" for="{{ form.no_estadist.id_for_label }}">
                                                    No Estadísticas
                                                </label>
                                            </div>

                                        </div>

                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label for="{{ form.movil_factura.id_for_label }}">Teléfono Móvil</label>
                                            </div>
                                        
                                            <div class="col-md-4">
                                                {{ form.movil_factura }}
                                            </div>

                                            <div class="col-md-4">
                                                {{ form.stock_clie }}
                                                <label class="form-check-label" for="{{ form.stock_clie.id_for_label }}">
                                                    Stock Cliente
                                                </label>
                                            </div>
                                        </div>

                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label for="{{ form.email_factura.id_for_label }}">Email</label>
                                            </div>

                                            <div class="col-md-9">
                                                {{ form.email_factura }}
                                            </div>
                                            
                                        </div>
                                        
                                    </div>
                                    <!-- sector derecho del encabezado end -->
                                </div>
                                <!--  Encabezado de Factura- Fin -->
                            </div>
                            </div>
                        </div>

                        <div class="container my-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <!-- Botones a la izquierda -->
                                <div>
                                    <button type="submit" class="btn btn-outline-success btn-sm">
                                        {% if is_edit %}Actualizar{% else %}Guardar{% endif %}
                                        <i class="bi bi-floppy"></i>
                                    </button>
                                    

                                    <a href="{% url 'factura_list' %}" class="btn btn-outline-secondary btn-sm me-2">
                                        Cancelar
                                        <i class="bi bi-x-circle"></i>
                                    </a>
                                </div>
                                <!-- Botón a la derecha -->
                                {% comment %} <button type="button" class="btn btn-outline-primary btn-sm me-2" data-bs-toggle="modal" data-bs-target="#detalleModal" id="btnAgregarDetalle">
                                    Agregar Detalle
                                    <i class="bi bi-file-earmark-plus"></i>
                                </button> {% endcomment %}

                                <button type="button" class="btn btn-outline-primary btn-sm me-2" id="btnAgregarDetalle">
                                    Agregar Detalle
                                    <i class="bi bi-file-earmark-plus"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseTwo" aria-expanded="false" aria-controls="panelsStayOpen-collapseTwo">
                                    Detalle de Venta
                                </button>
                            </h2>
                            
                            <div id="panelsStayOpen-collapseTwo" class="accordion-collapse collapse">
                                <div class="accordion-body">
                                    
                                    
                                    <div class="row tbl-fixed my-2 mx-1" id="formset-container">
                                        {{ formset_detalle.management_form }}
                                        
                                        <table class="detalle-form table table-striped table-hover table-responsive" style="width: 100%;">
                                            <thead class="table-primary small-font">
                                                <tr>
                                                    <th style="width: 12%;">Medida</th>
                                                    <th style="width: 30%;">Nombre Producto</th>
                                                    <th style="width: 8%;">Cantidad</th>
                                                    <th style="width: 8%;">Reventa</th>
                                                    <th style="width: 12%;">Precio</th>
                                                    <th style="width: 10%;">Descuento</th>
                                                    <th style="width: 15%;">Total</th>
                                                    <th style="width: 5%;">Elim</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {# Inicialmente no hay filas en el formulario #}
                                                {% for formdet in formset_detalle %}
                                                    <tr data-form-index="{{ forloop.counter0 }}">
                                                        <td>
                                                            {% if formdet.instance.pk %}
                                                                {{ formdet.id_detalle_factura }}
                                                                {{ formdet.id_factura }}
                                                                {{ formdet.id_producto }}     
                                                            {% endif %}
                                                            
                                                            {{ formdet.medida }}
                                                        </td>
                                                        
                                                        <td>{{ formdet.producto_venta }}</td>
                                                        <td>{{ formdet.cantidad }}</td>
                                                        <td>{{ formdet.reventa }}</td>
                                                        <td>{{ formdet.precio }}</td>
                                                        <td>{{ formdet.descuento }}</td>
                                                        <td>
                                                            {{ formdet.gravado }}
                                                            {{ formdet.alic_iva }}
                                                            {{ formdet.total }}</td>
                                                        <td>
                                                            <button type="button" class="btn btn-danger btn-sm btn-delete" 
                                                                data-form-index="{{ forloop.counter0 }}" data-toggle="tooltip" title="Eliminar">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                            <input type="checkbox" name="detallefactura_set-{{ forloop.counter0 }}-DELETE" id="id_detallefactura_set-{{ forloop.counter0 }}-DELETE" style="display: none;">
                                                        </td>
                                                    </tr>
                                                {% endfor %}

                                            </tbody>

                                            <tfoot>
                                                <tr>
                                                    <td colspan="6" class="text-end"><strong>Exento:</strong></td>
                                                    <td>
                                                        {{ form.exento }}
                                                    </td>
                                                    <td></td>
                                                </tr>

                                                
                                                <tr>
                                                    <td colspan="6" class="text-end"><strong>Total Factura:</strong></td>
                                                    <td>
                                                        <input type="number" id="total-factura" class="form-control form-control-sm text-end" value="0.00" readonly>
                                                    </td>
                                                    <td></td>
                                                </tr>
                                            </tfoot>
                                            
                                        </table>
                                    </div>
                                    
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Card del Detalle de Factura - Inicio -->
                    
                    <!-- Card del Detalle de Factura - Fin -->

                </form>
                <!-- Formulario Encabezado Detalle - Fin -->
            </div>
        </main>
    </div>
    {% endblock principalcomponent %}

{% endblock maincomponent %}
    
{% block modals %}
    {% comment %} Ventana Modal Buscar Producto Start {% endcomment %}
    <div class="modal fade" id="detalleModal" tabindex="-1" aria-labelledby="detalleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl" style="max-width: 90%;">
            <div class="modal-content">
                <div class="modal-header text-dark bg-primary bg-opacity-25 py-2">
                    <h5 class="modal-title fs-6" id="detalleModalLabel">Productos**</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Formulario modal -->
                    <form method="post" id="detalleForm">
                        {% csrf_token %}

                        <!-- Opciones de filtro adicionales -->
                        <div class="row mb-3">
                            <div class="col-md-12 d-flex justify-content-start align-items-center flex-wrap">
                                <label class="me-3 fw-bold">Filtrar por:</label>
                                
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="filtro_marca" id="filtro_primeras" value="primeras" checked>
                                    <label class="form-check-label" for="filtro_primeras">Primeras Marcas</label>
                                </div>
                                
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="filtro_marca" id="filtro_otras" value="otras">
                                    <label class="form-check-label" for="filtro_otras">Otras Marcas</label>
                                </div>

                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="filtro_marca" id="filtro_stock" value="stock">
                                    <label class="form-check-label" for="filtro_stock">Solo en Stock</label>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-3">
                                <input type="text" class="form-control form-control-sm border border-primary" id="medida_producto" placeholder="Medida Producto">
                            </div>
                            <div class="col-md-4">
                                <input type="text" class="form-control form-control-sm border border-primary" id="nombre_producto" placeholder="Nombre Producto">
                            </div>
                            <div class="col-md-3">
                                <input type="text" class="form-control form-control-sm border border-primary" id="cai_producto" placeholder="CAI Producto">
                            </div>
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-outline-primary btn-sm me-2">
                                    Buscar
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-responsive tbl-fixed" style="max-height: 30vh; overflow-y: auto;">
                            <table class="table table-striped small-text" id="tabla-resultados">
                                <thead class="table-primary fs-7">
                                    <th style="width: 12%;">Marca</th>
                                    <th style="width: 12%;">Medida</th>
                                    <th style="width: 10%;">CAI</th>
                                    <th style="width: 25%;">Nombre</th>
                                    <th style="width: 10%;">Precio</th>
                                    <th style="width: 8%;">Stock</th>
                                    <th style="width: 8%;">Mínimo</th>
                                    <th style="width: 8%;">Detalle</th>
                                    <th style="width: 8%;">...</th>
                                </thead>

                                <tbody>
                                </tbody>
                            </table>
                        </div>

                        <div class="d-flex align-items-center mt-3">
                            <!-- Título -->
                            <h6 id="titulo-producto" class="mb-0 me-auto" style="line-height: 1.5;">Título del Producto</h6>
                        
                            <!-- Botones -->
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-outline-primary btn-sm" id="agregarDetalle">Insertar</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal" id="cancelarDetalle">Cancelar</button>
                            </div>
                        </div>
                        
                        <!-- Sección de tablas de Stock y Mínimos -->
                        <div id="detalles-container" class="row mt-1">
                            <div class="col-md-6">
                                <h6>Stock por Depósito</h6>
                                <table id="tabla-stock" class="table table-striped small-text">
                                    <thead class="table-primary fs-7">
                                        <tr>
                                            <th>Depósito</th>
                                            <th>Stock</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabla-stock">
                                    </tbody>
                                </table>
                            </div>
                            
                        </div>

                        
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% comment %} Ventana Modal Buscar Producto End {% endcomment %}


    <!-- Modal para Listar Agenda-->
    <div class="modal fade" id="agendaModal" tabindex="-1" aria-labelledby="agendaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg" style="max-width: 90%;">
            <div class="modal-content">
                <div class="modal-header text-dark bg-primary bg-opacity-25 py-2">
                    <h5 class="modal-title fs-6" id="agendaModalLabel">Buscar en Agenda</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Formulario modal -->
                    <form method="post" id="buscarAgendaForm">
                        {% csrf_token %}
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <input type="text" class="form-control form-control-sm border border-primary" id="busquedaGeneral" placeholder="Buscar por id, cuit o nombre">
                            </div>
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-outline-primary btn-sm me-2">
                                    Buscar
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-responsive tbl-fixed">
                            <table class="table table-striped small-text" id="tablaResultadosAgenda">
                                <thead class="table-primary fs-7">
                                    <tr>
                                        <th scope="col" style="width: 10%;">ID Cliente</th>
                                        <th scope="col" style="width: 12%;">CUIT</th>
                                        <th scope="col" style="width: 25%;">Nombre</th>
                                        <th scope="col" style="width: 15%;">Móvil</th> <!-- Agregado -->
                                        <th scope="col" style="width: 20%;">Email</th> <!-- Agregado -->
                                        <th scope="col" style="width: 20%;">Dirección</th>
                                        <th scope="col" style="width: 8%;">Código Postal</th>
                                        <th scope="col" style="width: 5%;">Seleccionar</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                        <!-- Botones del formulario -->
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline-primary btn-sm me-2" id="seleccionarAgenda">
                                Seleccionar
                                <i class="bi bi-check2-circle"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal" id="cancelarAgenda">
                                Cancelar
                                <i class="bi bi-x-circle"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

{% endblock modals %}

{% block script %}
    {% comment %} SCRIPTS JS Start {% endcomment %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            //alert("carga inicial de la página 1!");
            /*
            const formsetContainer = document.getElementById('formset-container');

            // Agregar fila de total general al final del tfoot
            const tfootHTML = `
            <tfoot>
                <tr>
                    <td colspan="6" class="text-end"><strong>Total Factura:</strong></td>
                    <td>
                        <input type="number" id="total-factura" class="form-control form-control-sm text-end" value="0.00" readonly>
                    </td>
                    <td></td>
                </tr>
            </tfoot>
            `;
            formsetContainer.querySelector('.detalle-form').insertAdjacentHTML('beforeend', tfootHTML);
            */

            ////////////*
            // Función para actualizar el total general
            /* function actualizarTotalFactura() {
                // alert("Entro a la función Total Factura")
                let totalFactura = 0;
                formsetContainer.querySelectorAll('.detalle-form tbody tr').forEach(row => {
                    const total = parseFloat(row.querySelector('[name*="-total"]').value) || 0;
                    totalFactura += total;
                });
    
                // Actualizar el campo total general
                const totalFacturaInput = document.getElementById('total-factura');
                totalFacturaInput.value = totalFactura.toFixed(2);
            }
    
            // Recalcular total general dinámicamente
            formsetContainer.addEventListener('input', function (event) {
                if (['cantidad', 'precio', 'descuento'].some(field => event.target.name.includes(field))) {
                    const row = event.target.closest('tr');
                    const cantidad = parseFloat(row.querySelector('[name*="-cantidad"]').value) || 0;
                    const precio = parseFloat(row.querySelector('[name*="-precio"]').value) || 0;
                    const descuento = parseFloat(row.querySelector('[name*="-descuento"]').value) || 0;
                    const totalField = row.querySelector('[name*="-total"]');
    
                    // Recalcular total por fila
                    const total = (cantidad * precio) - descuento;
                    totalField.value = total.toFixed(2);
    
                    // Actualizar el total general
                    actualizarTotalFactura();
                }
            });
    
            // Actualizar el total general cuando se elimina una fila
            formsetContainer.addEventListener('click', function (event) {
                if (event.target.classList.contains('btn-delete')) {
                    const row = event.target.closest('tr');
                    row.remove(); // Elimina la fila
                    actualizarTotalFactura(); // Recalcula el total general
                }
            });
            */
            ////////////*
        });
    </script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            ////////////*
            const formsetContainer = document.getElementById('formset-container');

            ////////////
            function actualizarTotalFactura() {
                let totalFactura = 0;
                let hayFilasVisibles = false;
            
                // Recorre cada fila dentro de la tabla del detalle
                const filas = document.querySelectorAll('.detalle-form tbody tr');
                
                filas.forEach(row => {
                    // Solo considerar filas visibles (no eliminadas)
                    
                    if (row.style.display !== 'none') {
                        const totalField = row.querySelector('input[name^="detallefactura_set"][name$="-total"]');
                        
                        if (totalField && totalField.value) {  
                            totalFactura += parseFloat(totalField.value) || 0;
                            hayFilasVisibles = true;
                        }
                    }
                });
            
                // Actualizar el campo total general
                const totalFacturaInput = document.getElementById('total-factura');
                
                // Si no hay filas visibles o todas fueron eliminadas
                if (!hayFilasVisibles && filas.length > 0) {
                    totalFactura = 0;
                }
                
                totalFacturaInput.value = totalFactura.toFixed(2);
            }
            ////////////
            
            /*
            function actualizarTotalFactura() {
                alert("Actualizando totales!");
                let totalFactura = 0;

                // Recorre cada fila dentro de la tabla del detalle
                formsetContainer.querySelectorAll('.detalle-form tbody tr').forEach(row => {
                    const totalField = row.querySelector('input[name^="detallefactura_set"][name$="-total"]');

                    if (totalField && totalField.value) {  
                        totalFactura += parseFloat(totalField.value) || 0;
                    }
                });
    
                // Actualizar el campo total general
                const totalFacturaInput = document.getElementById('total-factura');
                totalFacturaInput.value = totalFactura.toFixed(2);
            }
            */
    
            // Recalcular total general dinámicamente
            formsetContainer.addEventListener('input', function (event) {
                if (['cantidad', 'precio', 'descuento'].some(field => event.target.name.includes(field))) {
                    const row = event.target.closest('tr');
                    const cantidad = parseFloat(row.querySelector('[name*="-cantidad"]').value) || 0;
                    const precio = parseFloat(row.querySelector('[name*="-precio"]').value) || 0;
                    const descuento = parseFloat(row.querySelector('[name*="-descuento"]').value) || 0;
                    const totalField = row.querySelector('[name*="-total"]');

                    const alicIva = parseFloat(row.querySelector('[name*="-alic_iva"]').value) || 0;

                    alert("*******");
    
                    // Recalcular total por fila
                    const total = (cantidad * precio) - descuento;
                    totalField.value = total.toFixed(2);

                    // Calcular base imponible (gravado) y IVA
                    const gravado = total / (1 + (alicIva / 100));
                    const iva = total - gravado;
                    alert(gravado);

                    // Actualizar campos ocultos - asegúrate de que estos selectores son correctos
                    const gravadoField = row.querySelector('[name*="-gravado"]');
                    const ivaField = row.querySelector('[name*="-iva"]');
                    
                    if (gravadoField) gravadoField.value = gravado.toFixed(2);
                    if (ivaField) ivaField.value = iva.toFixed(2);
    
                    // Actualizar el total general
                    actualizarTotalFactura();
                }
            });
    
            ////////////
            // Manejo mejorado de eliminación
            document.addEventListener('click', function (event) {
                if (event.target.closest('.btn-delete')) {
                    const row = event.target.closest('tr');
                    const deleteInput = row.querySelector('input[name$="-DELETE"]');
                    
                    if (confirm('¿Está seguro de eliminar este item de la factura???')) {
                        if (deleteInput) {
                            deleteInput.checked = true; // Marca para eliminación en backend
                            row.style.display = 'none';  // Oculta la fila visualmente
                            
                            // Actualiza los totales y el contador de formsets
                            actualizarTotalFactura();
                            actualizarContadorFormsets();
                        } else {
                            console.error('Error: No se encontró el campo DELETE');
                        }
                    }
                }
            });

            // Función para actualizar el contador de formsets (NUEVA)
            function actualizarContadorFormsets() {
                const visibleRows = document.querySelectorAll('.detalle-form tbody tr:not([style*="display: none"])').length;
                document.getElementById('id_detallefactura_set-TOTAL_FORMS').value = visibleRows;
            }
            ////////////

            // ✅ Si hay filas en la tabla, recalcular el total al cargar la página
            if (formsetContainer.querySelectorAll('.detalle-form tbody tr').length > 0) {
                actualizarTotalFactura();
            }
            ////////////*
            
            const buscarProductoForm = document.getElementById('detalleForm');
            const tablaResultados = document.querySelector('#tabla-resultados tbody');
            const detalleModal = document.getElementById('detalleModal');
            //const formsetContainer = document.getElementById('formset-container');
            const insertarBtn = document.getElementById('agregarDetalle');
            
            // Almacenar los productos seleccionados temporalmente
            let productosSeleccionados = [];

            // Clase reutilizable
            const formControlClass = 'form-control form-control-sm border border-primary small-font';
            
            // Evento para seleccionar productos
            tablaResultados.addEventListener('change', function(event) {
                if (event.target.matches('.seleccionar-producto')) {
                    const isChecked = event.target.checked;
                    const row = event.target.closest('tr');
                    const idProducto = event.target.getAttribute('data-id'); // Capturar ID del producto
                    //const medidaProducto = row.querySelector('td:nth-child(2)').textContent.trim();
                    //const nombreProducto = row.querySelector('td:nth-child(4)').textContent.trim();
                    const medidaProducto = event.target.getAttribute("data-medida"); // Obtener la medida del producto
                    const nombreProducto = event.target.getAttribute("data-nombre"); // Obtener el nombre de
                    //const precioProducto = parseFloat(row.querySelector('td:nth-child(5)').textContent.trim());
                    const precioProducto = parseFloat(event.target.getAttribute("data-precio"));
                    const descuentoVendedor = parseFloat(event.target.getAttribute("data-descuento-vendedor"));
                    
                    //const alicuotaIva = parseFloat(event.target.getAttribute("data-alicuota-iva"));
                    const alicuotaIva = parseFloat(event.target.getAttribute("data-alicuota-iva")).toFixed(2);
                    alert(alicuotaIva);

                    const producto = {
                        id: idProducto,
                        medida: medidaProducto,
                        nombre: nombreProducto,
                        precio: precioProducto,
                        descuento_vendedor: descuentoVendedor,
                        alicuota_iva: alicuotaIva   
                    };

                    if (isChecked) {
                        productosSeleccionados.push(producto);
                    } else {
                        productosSeleccionados = productosSeleccionados.filter(p => p.idProducto !== idProducto);
                    }
                }
            });
            
            
            
            const cambia_precio_descripcion = {{ cambia_precio_descripcion|yesno:"true,false" }};
            //alert(cambia_precio_descripcion);

            // Manejar el botón de insertar detalle de factura
            insertarBtn.addEventListener('click', function() {
                productosSeleccionados.forEach(producto => {
                    const currentIndex = formsetContainer.querySelectorAll('.detalle-form tbody tr').length;

                    const descuentoCalculado = (parseFloat(producto.descuento_vendedor) / 100) * parseFloat(producto.precio);
                    const precioConDescuento = (parseFloat(producto.precio) - descuentoCalculado).toFixed(2);
                    const cantidad = 1.00
                    const montoTotal =precioConDescuento * cantidad

                    // Determinar si el campo "nombre" es readonly o required
                    const nombreInputAttributes = cambia_precio_descripcion
                        ? 'required' // Si cambia_precio_descripcion es True, el campo es requerido
                        : 'readonly'; // Si cambia_precio_descripcion es False, el campo es de solo lectura

                    const precioFormateado = new Intl.NumberFormat("es-ES", {
                        style: "decimal",
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    }).format(producto.precio);

                    const alicuotaIva = parseFloat(producto.alicuota_iva);
                    const gravado = (montoTotal / (1 + (alicuotaIva / 100))).toFixed(2);
                    const iva = (montoTotal - gravado).toFixed(2);    

                    // Obtener el valor por defecto del campo tipo_venta
                    const valorPorDefecto = document.getElementById('id_tipo_venta') ? document.getElementById('id_tipo_venta').value : "M";
                    
                    ////****
                    //alert("Aquí es");
                    //alert(producto.id); 
                    
                    alert("Se construye la inseción de fila");
                    const newFormHTML = `
                    <tr data-form-index="${currentIndex}" class="small-font">

                        <!-- Inputs ocultos para manejar relaciones -->
                        <input type="hidden" name="detallefactura_set-${currentIndex}-id_detalle_factura" 
                            id="id_detallefactura_set-${currentIndex}-id_detalle_factura">
                        <input type="hidden" name="detallefactura_set-${currentIndex}-id_factura" 
                            id="id_detallefactura_set-${currentIndex}-id_factura">
                        <input type="hidden" name="detallefactura_set-${currentIndex}-id_producto" 
                            id="id_detallefactura_set-${currentIndex}-id_producto" value="${producto.id}">
                        <input type="hidden" name="detallefactura_set-${currentIndex}-precio_lista" 
                            id="id_detallefactura_set-${currentIndex}-precio_lista" value="${producto.precio}">

                        <td>${producto.medida}</td> <!-- Mostrar medida -->

                        <td>
                            <input type="text" name="detallefactura_set-${currentIndex}-producto_venta" 
                                class="${formControlClass}" value="${producto.nombre}" ${nombreInputAttributes}>
                        </td>
                        <td>
                            <input type="number" name="detallefactura_set-${currentIndex}-cantidad" 
                                class="${formControlClass} text-end" value="${cantidad}" min="1" step="1" required>
                        </td>
                        <td>
                            <select name="detallefactura_set-${currentIndex}-reventa" class="${formControlClass}" required>
                                <option value="M" ${valorPorDefecto === "M" ? "selected" : ""}>M</option>
                                <option value="R" ${valorPorDefecto === "R" ? "selected" : ""}>R</option>
                                <option value="E" ${valorPorDefecto === "E" ? "selected" : ""}>E</option>
                            </select>
                        </td>
                        <td>
                            <input type="number" name="detallefactura_set-${currentIndex}-precio" 
                                class="${formControlClass} text-end" value="${precioConDescuento}" ${nombreInputAttributes}
                                min="0" step="0.1">
                        </td>
                        <td>
                            <input type="number" name="detallefactura_set-${currentIndex}-descuento" 
                                class="${formControlClass} text-end" value="0" step="0.1" min="0">
                        </td>

                        <!-- Campos OCULTOS para IVA -->
                        <input type="hidden" name="detallefactura_set-${currentIndex}-gravado" 
                        value="${gravado}">
                        <input type="hidden" name="detallefactura_set-${currentIndex}-alic_iva" 
                        value="${parseFloat(producto.alicuota_iva || 0).toFixed(2)}">
                        <input type="hidden" 
                        name="detallefactura_set-${currentIndex}-iva" 
                        value="${iva}">
                        
                        <td>
                            <input type="number" name="detallefactura_set-${currentIndex}-total" 
                                class="${formControlClass} text-end" value="${montoTotal}" readonly>
                        </td>
                        
                        <td>
                            <button type="button" class="btn btn-danger btn-sm btn-delete" data-form-index="${currentIndex}" 
                                data-toggle="tooltip" title="Eliminar">
                                <i class="bi bi-trash"></i>
                            </button>
                            <input type="checkbox" name="detallefactura_set-${currentIndex}-DELETE" class="delete-checkbox" style="display: none;">
                        </td>
                    </tr>
                    `;
                    ////****

                    // Agregar la nueva fila al cuerpo de la tabla
                    formsetContainer.querySelector('.detalle-form tbody').insertAdjacentHTML('beforeend', newFormHTML);
                    
                    // Llamar a actualizarTotalFactura() después de agregar la fila
                    actualizarTotalFactura();
                    
                    // //
                    // Vincular eventos de cálculo a los nuevos campos
                    const newRow = formsetContainer.querySelector('.detalle-form tbody tr:last-child');
                    const cantidadInput = newRow.querySelector('[name*="-cantidad"]');
                    const precioInput = newRow.querySelector('[name*="-precio"]');
                    const descuentoInput = newRow.querySelector('[name*="-descuento"]');
                    const totalInput = newRow.querySelector('[name*="-total"]');

                    const recalcularTotalFila = () => {
                        const cantidad = parseFloat(cantidadInput.value) || 0;
                        const precio = parseFloat(precioInput.value) || 0;
                        const descuento = parseFloat(descuentoInput.value) || 0;
                        const total = (cantidad * precio) - descuento;
                        totalInput.value = total.toFixed(2);
                        
                    };

                    cantidadInput.addEventListener('input', recalcularTotalFila);
                    precioInput.addEventListener('input', recalcularTotalFila);
                    descuentoInput.addEventListener('input', recalcularTotalFila);
                    
                    // //
                    //alert("entró al cálculo");

                    // Actualizar el valor de TOTAL_FORMS
                    const totalFormsInput = document.querySelector('[name$="TOTAL_FORMS"]');
                    totalFormsInput.value = formsetContainer.querySelectorAll('.detalle-form tbody tr').length;

                    //console.log("totalFormsInput.value", totalFormsInput.value);

                });

                // Aquí es
                // alert("Aqui es!");
                // actualizarTotalFactura();

                // Limpiar productos seleccionados y cerrar la ventana modal
                productosSeleccionados = [];
                detalleModal.querySelector('.btn-close').click();
            });

            // ✅ Evento que detecta cambios en los select de "reventa"
            formsetContainer.addEventListener('change', function(event) {
                if (event.target.matches('[name*="-reventa"]')) {
                    const row = event.target.closest('tr');
                    const nombreProducto = row.querySelector('[name*="-nombre"]').value;
                    alert(`Producto seleccionado: ${nombreProducto}`);
                }
            });

            ////////////
            formsetContainer.addEventListener('input', function(event) {
                if (event.target.matches('[name*="-precio"]')) {
                    if (parseFloat(event.target.value) <= 0) {
                        alert("El precio debe ser mayor a 0.");
                        event.target.value = "";  // Borra el valor inválido
                        event.target.focus();  // Vuelve a enfocar el input
                    }
                }
            
                if (event.target.matches('[name*="-descuento"]')) {
                    let descuento = parseFloat(event.target.value);
                    if (descuento < 0 || descuento > 99) {
                        alert("El descuento debe estar entre 0 y 99.");
                        event.target.value = "0";  // Restablece el valor a 0 si es inválido
                        event.target.focus();
                    }
                }
            });
            ////////////

            // Recalcular total dinámicamente
            formsetContainer.addEventListener('input', function (event) {
                if (['cantidad', 'precio', 'descuento'].some(field => event.target.name.includes(field))) {
                    const row = event.target.closest('tr');
                    const cantidad = parseFloat(row.querySelector('[name*="-cantidad"]').value) || 0;
                    const precio = parseFloat(row.querySelector('[name*="-precio"]').value) || 0;
                    const descuento = parseFloat(row.querySelector('[name*="-descuento"]').value) || 0;
                    const totalField = row.querySelector('[name*="-total"]');

                    const total = (cantidad * precio) - descuento;
                    totalField.value = total.toFixed(2);
                }
            });

            // Limpiar filtros y resultados cuando se cierra la ventana modal
            detalleModal.addEventListener('hidden.bs.modal', function () {
                buscarProductoForm.reset(); // Restablecer el formulario
                tablaResultados.innerHTML = ''; // Limpiar la tabla de resultados
                productosSeleccionados = []; // Limpiar la lista de productos seleccionados
            });

            // Manejar el submit del formulario de búsqueda de producto
            buscarProductoForm.addEventListener('submit', function (event) {
                event.preventDefault();

                // Obtiene los valores de los filtros generales
                const medidaProducto = document.getElementById('medida_producto').value;
                const nombreProducto = document.getElementById('nombre_producto').value;
                const caiProducto = document.getElementById('cai_producto').value;

                // Obtener el valor del ID del cliente
                const idCliente = document.getElementById('id_id_cliente').value; 

                // Obtener el valor seleccionado del filtro de marcas
                const filtroMarcaElement = document.querySelector('input[name="filtro_marca"]:checked');
                const filtroMarca = filtroMarcaElement ? filtroMarcaElement.value : '';

                // Buscar Producto
                // new URL(path, base) es un constructor que crea un objeto URL válido
                const url = new URL('/ventas/buscar/producto/', window.location.origin);
                url.searchParams.append('medida', medidaProducto);
                url.searchParams.append('nombre', nombreProducto);
                url.searchParams.append('cai', caiProducto);
                url.searchParams.append('filtro_marca', filtroMarca);
                url.searchParams.append('id_cliente', idCliente);  // 🔥 ¡Aquí está el cambio clave!

                // Realiza una solicitud GET a la URL especificada para obtener datos en formato JSON.
                // La respuesta se procesa de forma asincrónica y, cuando los datos son recibidos, 
                // se actualiza la tabla de resultados con la información obtenida.
                fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                })
                .then(response => response.json())
                .then(data => {
                    tablaResultados.innerHTML = ''; // Limpiar tabla de resultados

                    const formateadorPrecio = new Intl.NumberFormat('es-ES', {
                        style: 'decimal',
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2,
                    });
                    
                    data.forEach(producto => {
                        const precioNumerico = parseFloat(producto.precio); // Asegura que sea número
                        const precioFormateado = formateadorPrecio.format(producto.precio);
                        const descuentoVendedor = parseFloat(producto.descuento_vendedor);

                        // alert(`Precio numérico: ${precioNumerico}`);
                        // alert(`Descuento: ${descuentoVendedor}`);
                        
                        const fila = `
                            <tr>
                                <td>${producto.marca}</td>
                                <td>${producto.medida}</td>
                                <td>${producto.cai || 'N/A'}</td>
                                <td>${producto.nombre}</td>
                                <td class="text-end"><strong>${precioFormateado}</strong></td>
                                <td class="text-end">${producto.stock}</td>
                                <td class="text-end">${producto.minimo}</td>
                                
                                <td class="text-center">
                                    <button type="button" class="btn btn-info btn-sm actualizar-detalle" 
                                        data-id="${producto.id}" 
                                        data-nombre="${producto.nombre}"
                                        data-cai="${producto.cai || 'N/A'}">
                                        
                                        <i class="bi bi-eye"></i> <!-- Icono de Bootstrap -->
                                    </button>
                                </td>

                                <td>
                                    <input type="checkbox" class="seleccionar-producto"
                                            data-id="${producto.id}" 
                                            data-codigo="${producto.codigo}" 
                                            data-medida="${producto.medida}"
                                            data-nombre="${producto.nombre}"
                                            data-precio="${precioNumerico}"
                                            data-id-marca="${producto.id_marca}" 
                                            data-id-familia="${producto.id_familia}"
                                            data-descuento-vendedor="${producto.descuento_vendedor}"
                                            data-id-alicuota-iva="${producto.id_alicuota_iva}"
                                            data-alicuota-iva="${producto.alicuota_iva}">
                                            
                                </td>
                            </tr>
                        `;
                        tablaResultados.insertAdjacentHTML('beforeend', fila);
                    });

                    // Agregar eventos a los nuevos botones de actualización
                    document.querySelectorAll('.actualizar-detalle').forEach(button => {
                        button.addEventListener('click', function () {
                            const idProducto = this.getAttribute('data-id');
                            const nombreProducto = this.getAttribute('data-nombre');
                            const nombreCAI = this.getAttribute('data-cai');

                            ///
                            // Cambiar el color del botón clicado y resetear los demás
                            document.querySelectorAll('.actualizar-detalle').forEach(btn => {
                                btn.classList.remove('btn-success'); // Remover clase de todos los botones
                                btn.classList.add('btn-info'); // Restaurar clase predeterminada
                            });
                            this.classList.remove('btn-info'); // Remover clase predeterminada del botón clicado
                            this.classList.add('btn-success'); // Agregar clase de éxito
                            ///
                            
                            actualizarDetallesProducto(idProducto, nombreProducto, nombreCAI);
                        });
                    });

                })
                .catch(error => {
                    console.error('Error al buscar productos:', error);
                });
            });

            // Función para actualizar las tablas de stock y mínimos
            function actualizarDetallesProducto(idProducto, nombreProducto, nombreCAI) {
                
                // Mostrar el nombre del producto arriba de las tablas
                document.getElementById('titulo-producto').innerText = `Producto: ${idProducto} - ${nombreProducto} - CAI: ${nombreCAI}`;
            
                // Obtener referencias a las tablas de stock y mínimos
                const tablaStock = document.getElementById("tabla-stock").querySelector("tbody");
                

                // Limpiar las tablas antes de insertar los nuevos datos
                tablaStock.innerHTML = "";
                

                // Realizar la solicitud para obtener los detalles del producto
                fetch(`/ventas/detalle_producto/${idProducto}/`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Error en la solicitud: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Verificar y agregar datos de stock
                        if (data.stock && data.stock.length > 0) {
                            //
                            let tieneStock = false; // Bandera para verificar si hay stock mayor a cero
                            data.stock.forEach(stock => {
                                if (parseFloat(stock.stock) > 0) { // Solo mostrar si el stock es mayor a cero
                                    const row = `<tr><td>${stock.deposito}</td><td>${stock.stock}</td></tr>`;
                                    tablaStock.insertAdjacentHTML("beforeend", row);
                                    tieneStock = true;
                                }
                            });
                            if (!tieneStock) {
                                const row = `<tr><td colspan="2">No hay stock disponible mayor a cero.</td></tr>`;
                                tablaStock.insertAdjacentHTML("beforeend", row);
                            }
                            //
                        } else {
                            const row = `<tr><td colspan="2">No hay información de stock disponible.</td></tr>`;
                            tablaStock.insertAdjacentHTML("beforeend", row);
                        }

                        // Verificar y agregar datos de mínimos
                        
                    })
                    .catch(error => {
                        console.error('Error al obtener detalles del producto:', error);
                        const errorRow = `<tr><td colspan="2">Error al cargar los datos.</td></tr>`;
                        tablaStock.insertAdjacentHTML("beforeend", errorRow);
                        
                    });

            }

            ///////
            
            ///////

        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const detalleModal = document.getElementById('detalleModal');

            detalleModal.addEventListener('show.bs.modal', function () {
                // Limpiar el título del producto
                document.getElementById('titulo-producto').innerText = "Producto";
        
                // Limpiar las tablas antes de abrir la ventana modal
                document.querySelector("#tabla-stock tbody").innerHTML = "";
                document.querySelector("#tabla-minimos tbody").innerHTML = "";
            });
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('validarBtn').addEventListener('click', function() {
                const nroDocIdentidad = document.getElementById('id_cuit').value;

                console.log("Entró al script");
                //alert(nroDocIdentidad);
                console.log(nroDocIdentidad);
            
                fetch('/ventas/validar/documento/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')  // Asegúrate de incluir el token CSRF si es necesario
                    },
                    body: JSON.stringify({ nro_doc_identidad: nroDocIdentidad })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.exists) {
                        // Asignar los valores a los inputs correspondientes
                        alert("Encontrado ojo!!!")
                        document.getElementById('id_nombre_factura').value = data.nombre_receptor || '';
                        document.getElementById('id_domicilio_factura').value = data.domicilio_receptor || '';
                    } else {
                        alert('El documento no existe.');
                    }
                })
                .catch(error => console.error('Error:', error));
            });
        
            // Función para obtener el token CSRF del cookie
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
        });
        
    </script>
    {% comment %} SCRIPTS JS End {% endcomment %}

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const buscarAgendaForm = document.getElementById('buscarAgendaForm');
            const tablaResultadosAgenda = document.getElementById('tablaResultadosAgenda').querySelector('tbody');
        
            // alert("capturando el submit de buscarAgendaForm")
            
            buscarAgendaForm.addEventListener('submit', function (event) {
                event.preventDefault();
        
                const busquedaGeneral = document.getElementById('busquedaGeneral').value;

                // Validar que la búsqueda tenga al menos 4 caracteres
                if (busquedaGeneral.length < 4) {
                    alert('Por favor, ingrese al menos 4 caracteres para realizar la búsqueda.');
                    return;
                }

                // const url = `/ventas/buscar/agenda/?busqueda_general=${busquedaGeneral}`;
                const url = new URL('/ventas/buscar/agenda/', window.location.origin);
                url.searchParams.append('busqueda_general', busquedaGeneral);

                fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                })
                .then(response => response.json())
                .then(data => {
                    tablaResultadosAgenda.innerHTML = ''; // Limpiar tabla de resultados
        
                    data.forEach(agenda => {

                        const fila = `
                            <tr>
                                <td>${agenda.id_cliente}</td>
                                <td>${agenda.cuit}</td>
                                <td>${agenda.nombre_cliente}</td>
                                <td>${agenda.movil_cliente || 'N/A'}</td>  <!-- Muestra Móvil -->
                                <td>${agenda.email_cliente || 'N/A'}</td>  <!-- Muestra Email -->
                                <td>${agenda.domicilio_cliente}</td>
                                <td>${agenda.codigo_postal}</td>
                                <td>
                                    <input type="radio" name="seleccionar-agenda" 
                                        class="seleccionar-agenda" 
                                        data-id="${agenda.id_cliente}" 
                                        data-cuit="${agenda.cuit}" 
                                        data-nombre="${agenda.nombre_cliente}" 
                                        data-direccion="${agenda.domicilio_cliente}" 
                                        data-movil="${agenda.movil_cliente}"  
                                        data-email="${agenda.email_cliente}"
                                        data-id_vendedor="${agenda.id_vendedor}"
                                        data-nombre_vendedor="${agenda.id_vendedor__nombre_vendedor}"
                                        data-tipo_venta="${agenda.id_vendedor__tipo_venta}"
                                        data-nombre_iva="${agenda.id_tipo_iva__nombre_iva}"
                                        data-discrimina_iva="${agenda.id_tipo_iva__discrimina_iva}"
                                        data-condicion_venta="${agenda.condicion_venta}"
                                        data-id_sucursal="${agenda.id_sucursal}" 
                                        data-vip="${agenda.vip}"  
                                        data-mayorista="${agenda.mayorista}"  
                                        data-sub_cuenta="${agenda.sub_cuenta}"  
                                        data-observaciones="${agenda.observaciones_cliente}"  
                                        data-black_list="${agenda.black_list}"  
                                        data-black_list_motivo="${agenda.black_list_motivo}">
                                </td>
                            </tr>
                        `;
                        
                        // console.log("Fila insertada:", fila);  // 📌 Verifica si data-email está en el HTML
                        tablaResultadosAgenda.insertAdjacentHTML('beforeend', fila);
                    });
                    
                })
                .catch(error => {
                    console.error('Error al buscar en agenda:', error);
                });
            });
        
            // Botón seleccionar de Lista de Clientes
            document.getElementById('seleccionarAgenda').addEventListener('click', function () {
                const seleccion = document.querySelector('input[name="seleccionar-agenda"]:checked');

                if (seleccion) {
                    const id_cliente = seleccion.getAttribute('data-id');
                    const cuit = seleccion.getAttribute('data-cuit');
                    const nombre = seleccion.getAttribute('data-nombre');
                    const direccion = seleccion.getAttribute('data-direccion');
                    const movil = seleccion.getAttribute('data-movil');
                    const email = seleccion.getAttribute('data-email');
                    const id_vendedor = seleccion.getAttribute('data-id_vendedor');
                    const nombre_vendedor = seleccion.getAttribute('data-nombre_vendedor');
                    const tipo_venta = seleccion.getAttribute('data-tipo_venta');
                    const discrimina_iva = seleccion.getAttribute('data-discrimina_iva');
                    const isChecked = discrimina_iva === "true";
                    const condicion_comprobante = seleccion.getAttribute('data-condicion_venta');
                    const id_sucursal_cliente = seleccion.getAttribute('data-id_sucursal');
                    // Genera un booleano sin es string
                    const vip = seleccion.getAttribute('data-vip') === 'true';

                    // document.getElementById('id_letra_comprobante').value = isChecked ? 'A' : 'B';
                    const esRemito = document.getElementById('id_es_remito').checked;
                    document.getElementById('id_letra_comprobante').value = esRemito ? 'R' : (isChecked ? 'A' : 'B');

                    // Numeración
                    // compro
                    // letra_comprobante
                    // numero_comprobante

                    
                    // const vip = seleccion.getAttribute('data-vip')
                    //const mayorista = seleccion.getAttribute('data-mayorista');
                    //const sub_cuenta = seleccion.getAttribute('data-sub_cuenta');
                    //const observaciones = seleccion.getAttribute('data-observaciones');
                    //const black_list = seleccion.getAttribute('data-black_list');
                    //const black_list_motivo = seleccion.getAttribute('data-black_list_motivo');;

                    //alert(discrimina_iva);
                    
                    document.getElementById('id_id_cliente').value = id_cliente || '';
                    document.getElementById('id_nombre_factura').value = nombre || '';
                    document.getElementById('id_domicilio_factura').value = direccion || '';
                    document.getElementById('id_cuit').value = cuit || '';
                    document.getElementById('id_movil_factura').value = movil || '';
                    document.getElementById('id_email_factura').value = email || '';
                    document.getElementById('id_id_vendedor').value = id_vendedor || '';
                    document.getElementById('id_vendedor_factura').value = nombre_vendedor || '';
                    document.getElementById('id_tipo_venta').value = tipo_venta || '';
                    document.getElementById('id_condicion_comprobante').value = condicion_comprobante || '';
                    document.getElementById('id_discrimina_iva').checked = isChecked;
                    
                    const id_sucursal_factura = document.getElementById('id_id_sucursal').value;
                    //alert(`id_sucursal_factura ${id_sucursal_factura}`);
                    //alert(`id_sucursal_cliente ${id_sucursal_cliente}`);

                    // Asignar el valor de condicion_comprobante
                    const condicionComprobanteSelect = document.getElementById('id_condicion_comprobante');
                    if (condicionComprobanteSelect) {
                        condicionComprobanteSelect.value = condicion_comprobante || '';

                        // Aplicar la lógica de solo lectura si el valor es "1"
                        if (condicion_comprobante === "1") {
                            // Deshabilitar todas las opciones excepto la seleccionada
                            Array.from(condicionComprobanteSelect.options).forEach(function(option) {
                                if (option.value !== condicion_comprobante) {
                                    option.disabled = true;
                                }
                            });

                            // Aplicar estilo visual para indicar que es de solo lectura
                            condicionComprobanteSelect.classList.add('readonly-select');
                        }
                    }

                    // Comparar sucursales
                    if (id_sucursal_cliente !== id_sucursal_factura) {
                        alert('Atención: El cliente pertenece a otra sucursal.');
                    }

                    if (vip) {
                        alert("⚠️ Este es un Cliente VIP - Trato Especial ⚠️");
                        document.getElementById('id_cliente_vip').value = "Cliente VIP" 
                    }

                    // Inicio Número de Comprobante
                    // Obtener valores para el número de comprobante
                    const id_sucursal = document.getElementById('id_id_sucursal').value;
                    const id_punto_venta = document.getElementById('id_id_punto_venta').value;
                    const compro = document.getElementById('id_compro').value;
                    const letra_comprobante = document.getElementById('id_letra_comprobante').value;

                    // Solo hacer la solicitud si tenemos todos los valores necesarios
                    if (id_sucursal && id_punto_venta && compro && letra_comprobante) {
                        const url = new URL('/ventas/obtener-numero-comprobante/', window.location.origin);
                        url.searchParams.append('id_sucursal', id_sucursal);
                        url.searchParams.append('id_punto_venta', id_punto_venta);
                        url.searchParams.append('comprobante', compro);
                        url.searchParams.append('letra', letra_comprobante);

                        fetch(url, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Asignar el número referencial al campo del formulario
                                document.getElementById('id_numero_comprobante').value = data.numero_referencial;
                                
                                // Opcional: Guardar el número definitivo en un campo oculto
                                const inputDefinitivo = document.getElementById('id_numero_definitivo');
                                if (inputDefinitivo) {
                                    inputDefinitivo.value = data.numero_definitivo;
                                }
                            } else {
                                console.error('Error al obtener número:', data.error);
                            }
                        })
                        .catch(error => {
                            console.error('Error en la solicitud:', error);
                        });
                    } else {
                        console.log('Faltan datos para obtener el número de comprobante');
                    }
                    // Final Número de Comprobante

                    //document.getElementById('id_id_sucursal').value = id_sucursal || '';
                    //document.getElementById('id_vip').value = vip === 'true' ? 'Sí' : 'No';
                    //document.getElementById('id_mayorista').value = mayorista === 'true' ? 'Sí' : 'No';
                    //document.getElementById('id_sub_cuenta').value = sub_cuenta || '';
                    //document.getElementById('id_observaciones').value = observaciones || '';
                    //document.getElementById('id_black_list').value = black_list === 'true' ? 'Sí' : 'No';
                    //document.getElementById('id_black_list_motivo').value = black_list_motivo || '';
                    
                    // Cerrar el modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('agendaModal'));
                    modal.hide();
                }
            });

            // Limpiar filtros y resultados cuando se cierra la ventana modal
            agendaModal.addEventListener('hidden.bs.modal', function () {
                buscarAgendaForm.reset(); // Restablecer el formulario
                tablaResultadosAgenda.innerHTML = ''; // Limpiar la tabla de resultados
            });
        });

        
    </script>

    <script>
        /*
        document.addEventListener("DOMContentLoaded", function () {
            const depositoSelect = document.getElementById("id_deposito_select");
            const depositoHidden = document.getElementById("id_id_deposito");  // Campo oculto
    
            // Sincronizar el valor del campo oculto con el select visible
            depositoSelect.addEventListener("change", function () {
                // Asignar el valor seleccionado al campo oculto
                depositoHidden.value = depositoSelect.value;
    
                // Deshabilitar el select después de la selección
                depositoSelect.disabled = true;
            });
        });
        */
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Función para aplicar la lógica de solo lectura a un campo select
            function makeSelectReadOnly(selectElement) {
                // Guarda el valor inicial seleccionado
                var initialValue = selectElement.value;
        
                // Deshabilita la interacción después de la primera selección
                selectElement.addEventListener('change', function() {
                    // Deshabilita todas las opciones excepto la seleccionada
                    Array.from(selectElement.options).forEach(function(option) {
                        if (option.value !== selectElement.value) {
                            option.disabled = true;
                        }
                    });
        
                    // Aplica un estilo visual para indicar que es de solo lectura
                    selectElement.classList.add('readonly-select');
                });
        
                // Si ya hay un valor seleccionado al cargar la página, deshabilita las otras opciones
                if (selectElement.value) {
                    Array.from(selectElement.options).forEach(function(option) {
                        if (option.value !== selectElement.value) {
                            option.disabled = true;
                        }
                    });
                    selectElement.classList.add('readonly-select');
                }
            }
        
            // Aplicar la lógica a id_deposito
            var selectDeposito = document.getElementById('id_id_deposito');
            if (selectDeposito) {
                makeSelectReadOnly(selectDeposito);
            }
        
            // Aplicar la lógica a id_comprobante_venta
            var selectComprobante = document.getElementById('id_id_comprobante_venta');
            if (selectComprobante) {
                makeSelectReadOnly(selectComprobante);
            }
            
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Función para aplicar la lógica de solo lectura a un campo select
            function makeSelectReadOnly(selectElement) {
                // Guarda el valor inicial seleccionado
                var initialValue = selectElement.value;
        
                // Deshabilita la interacción después de la primera selección
                selectElement.addEventListener('change', function() {
                    // Deshabilita todas las opciones excepto la seleccionada
                    Array.from(selectElement.options).forEach(function(option) {
                        if (option.value !== selectElement.value) {
                            option.disabled = true;
                        }
                    });
        
                    // Aplica un estilo visual para indicar que es de solo lectura
                    selectElement.classList.add('readonly-select');
                });
        
                // Si ya hay un valor seleccionado al cargar la página, pero no es el valor por defecto, deshabilita las otras opciones
                if (selectElement.value && selectElement.value !== selectElement.options[0].value) {
                    Array.from(selectElement.options).forEach(function(option) {
                        if (option.value !== selectElement.value) {
                            option.disabled = true;
                        }
                    });
                    selectElement.classList.add('readonly-select');
                }
            }
        
            // Aplicar la lógica a condicion_comprobante
            var selectCondicionComprobante = document.getElementById('id_condicion_comprobante');
            if (selectCondicionComprobante) {
                makeSelectReadOnly(selectCondicionComprobante);
            }
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Botón de "Listar" que abre la ventana modal
            const listarBtn = document.querySelector('[data-bs-target="#agendaModal"]');
            
            // Evento cuando se hace clic en "Seleccionar" en la ventana modal de agenda
            document.getElementById('seleccionarAgenda').addEventListener('click', function () {
                const seleccion = document.querySelector('input[name="seleccionar-agenda"]:checked');
                if (seleccion) {
                    // Deshabilitar el botón "Listar"
                    listarBtn.disabled = true;
                }
            });
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('btnAgregarDetalle').addEventListener('click', function (event) {
                // Lista de IDs de los campos obligatorios
                const requiredFields = [
                    'id_id_deposito', 'id_id_comprobante_venta', 'id_id_cliente', 
                    'id_fecha_comprobante', 'id_condicion_comprobante', 
                    'id_movil_factura', 'id_email_factura'
                ];
        
                let isValid = true;
                let missingFields = [];
        
                // Validar cada campo obligatorio
                requiredFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (!field || !field.value.trim()) {
                        isValid = false;
                        missingFields.push(fieldId);
                    }
                });
        
                // Si hay campos faltantes, mostrar alerta y evitar abrir el modal
                if (!isValid) {
                    event.preventDefault();  // Evita cualquier acción por defecto
                    event.stopPropagation(); // Detiene la propagación del evento
        
                    alert("⚠️ Debes completar todos los datos obligatorios antes de agregar un detalle.\n\nFaltan los siguientes campos:\n- " + missingFields.join("\n- "));
                    return false; // Detiene la ejecución del código
                }
        
                // Si pasa la validación, abrir el modal manualmente
                const detalleModal = new bootstrap.Modal(document.getElementById('detalleModal'));
                detalleModal.show();
            });
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const buscarClienteInput = document.getElementById('buscar_cliente');

            buscarClienteInput.addEventListener('blur', function () {
                let busqueda = buscarClienteInput.value.trim();

                
        
                // Si está vacío, no hacer nada
                if (!busqueda) return;
        
                // Verificar que solo contenga números
                if (!/^\d+$/.test(busqueda)) {
                    alert("Solo se permiten valores numéricos enteros.");
                    buscarClienteInput.value = '';
                    buscarClienteInput.focus();
                    return;
                }
        
                // Construir la URL para la búsqueda
                const url = new URL('/ventas/buscar/cliente/', window.location.origin);
                url.searchParams.append('busqueda', busqueda);
        
                fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                        buscarClienteInput.value = '';
                        buscarClienteInput.focus();
                    } else {
                        console.log("Cliente encontrado:", data);
                        // Aquí puedes actualizar otros campos si es necesario
                        //document.getElementById('id_nombre_factura').value = data.nombre_cliente || '';
                        //document.getElementById('id_domicilio_factura').value = data.domicilio_cliente || '';

                        ///////
                        document.getElementById('id_id_cliente').value = data.id_cliente || '';

                        document.getElementById('id_nombre_factura').value = data.nombre || '';
                        document.getElementById('id_domicilio_factura').value = data.direccion || '';
                        
                        document.getElementById('id_cuit').value = data.cuit || '';
                        document.getElementById('id_movil_factura').value = data.movil || '';
                        document.getElementById('id_email_factura').value = data.email || '';
                        document.getElementById('id_id_vendedor').value = data.id_vendedor || '';
                        document.getElementById('id_vendedor_factura').value = data.nombre_vendedor || '';

                        const id_sucursal_factura = document.getElementById('id_id_sucursal').value;
                        //alert(`id_sucursal_factura ${id_sucursal_factura}`);
                        //alert(`id_sucursal_cliente ${id_sucursal_cliente}`);

                        if (data.id_sucursal !== id_sucursal_factura) {
                            alert('Atención: El cliente pertenece a otra sucursal.');
                        }

                        if (data.vip) {
                            alert("⚠️ Este es un Cliente VIP - Trato Especial ⚠️");
                            document.getElementById('id_cliente_vip').value = "Cliente VIP" 
                        }

                        document.getElementById('listar_agenda').disabled = true;
                        document.getElementById('buscar_cliente').disabled = true;
                        ///////
                    }
                })
                .catch(error => {
                    console.error('Error en la búsqueda:', error);
                    alert("Hubo un error en la búsqueda.");
                });
            });
        });
    </script>

    
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Obtener el elemento HTML que contiene el valor de is_edit
            const modoEdicion = document.getElementById('modo-edicion');

            // Obtener el valor de data-is-edit y convertirlo a booleano
            const isEdit = modoEdicion.dataset.isEdit === 'true';

            // Si estamos en modo de edición, deshabilitar los campos y el botón
            if (isEdit) {
                // Deshabilitar solo los campos de entrada y el botón "Agregar Detalle"
                const inputs = document.querySelectorAll('#factura-form input, #factura-form select, #factura-form textarea');
                const btnAgregarDetalle = document.getElementById('btnAgregarDetalle');

                inputs.forEach(input => {
                    input.disabled = true;  // Deshabilitar campos
                    input.classList.add('readonly-select');  // Aplicar estilo visual
                });

                if (btnAgregarDetalle) {
                    btnAgregarDetalle.disabled = true;  // Deshabilitar el botón "Agregar Detalle"
                }

                //alert("El formulario está en modo de solo lectura");
            } else {
                //alert("El formulario está en modo de creación");
            }
        });   
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const comprobanteSelect = document.getElementById('id_id_comprobante_venta');
            
            if (comprobanteSelect) {
                // Asignar el event listener
                comprobanteSelect.addEventListener('change', function() {
                    actualizarDatosComprobante(this);
                });
                
                // Ejecutar al cargar si ya hay un valor seleccionado
                if (comprobanteSelect.value) {
                    actualizarDatosComprobante(comprobanteSelect);
                }
            }
            
            function actualizarDatosComprobante(selectElement) {
                const comprobanteId = selectElement.value;
                
                if (!comprobanteId) {
                    // Limpiar campos si no hay comprobante seleccionado
                    document.getElementById('id_compro').value = '';
                    document.getElementById('id_letra_comprobante').value = '';
                    return;
                }

                // 1. Campo de búsqueda de cliente
                const buscarCliente = document.getElementById('buscar_cliente');
                if (buscarCliente) {
                    buscarCliente.removeAttribute('readonly');
                }
                
                // 2. Botón de validar
                const validarBtn = document.getElementById('validarBtn');
                if (validarBtn) {
                    validarBtn.removeAttribute('disabled');
                }
                
                // 3. Botón de listar agenda
                const listarAgenda = document.getElementById('listar_agenda');
                if (listarAgenda) {
                    listarAgenda.removeAttribute('disabled');
                }
        
                // Obtener solo los datos básicos del comprobante
                fetch(`/ventas/comprobante/${comprobanteId}/codigo/`)
                    .then(response => {
                        if (!response.ok) throw new Error('Error en la respuesta');
                        return response.json();
                    })
                    .then(data => {
                        document.getElementById('id_compro').value = data.codigo || '';

                        // Actualizar el checkbox es_remito basado en la respuesta
                        const esRemitoCheckbox = document.getElementById('id_es_remito');
                        if (esRemitoCheckbox) {
                            esRemitoCheckbox.checked = data.es_remito || false;
                            
                            // Si necesitas cambiar el estado visual (aunque esté disabled)
                            if (data.es_remito) {
                                esRemitoCheckbox.parentElement.classList.add('checked');
                            } else {
                                esRemitoCheckbox.parentElement.classList.remove('checked');
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error al obtener código:', error);
                        document.getElementById('id_compro').value = '';
                    });

            }
        });
    </script>

{% endblock script %}
