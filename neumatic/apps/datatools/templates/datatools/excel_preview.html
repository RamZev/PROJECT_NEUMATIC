<!-- apps\datatools\templates\datatools\excel_preview.html -->
{% extends 'base.html' %}
{% load static %}
{% load custom_tags %}

{% block title %}Previsualización de Excel{% endblock %}

{% block style %}
	<style>
		.table-responsive {
			overflow-x: auto;
			max-height: 70vh;
		}
		
		.table-fit {
			width: auto !important;
			min-width: 100%;
			border-collapse: separate;
			border-spacing: 0;
		}
		
		.table-fit th,
		.table-fit td {
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
			max-width: 400px;
			padding: 4px 8px;
			font-size: 0.9rem;
			border: 1px solid #dee2e6;
			vertical-align: middle;
		}
		
		.table-fit th {
			background-color: #f8f9fa;
			font-weight: 600;
			position: sticky;
			top: 0;
			z-index: 10;
		}
		.table-fit thead th {
			background-color: #b6d4fe;
			color: #000;
		}
		
		.table-fit td {
			position: relative;
		}
		
		.table-fit td:hover::before {
			content: attr(data-content);
			position: absolute;
			left: 0;
			top: 100%;
			background: #fff;
			border: 1px solid #ccc;
			padding: 8px;
			z-index: 1000;
			white-space: normal;
			width: auto;
			max-width: 400px;
			box-shadow: 0 2px 8px rgba(0,0,0,0.15);
			font-size: 0.85rem;
			line-height: 1.4;
		}
		
		.card-body {
			padding: 1rem;
		}
		
		.badge-count {
			font-size: 0.8rem;
			vertical-align: middle;
		}
		
		/*--- Estilo para números alineados a la derecha ---*/
		.number-cell {
			text-align: right;
			font-family: monospace;
		}
		
		/*--- Estilos para el panel de la derecha ---*/
		.container-main {
			display: flex;
			gap: 20px;
		}
		
		.table-container {
			flex: 3;
			position: relative;
		}
		
		.form-container {
			flex: 1;
			min-width: 300px;
		}
		
		.campos-form {
			background: #f8f9fa;
			padding: 20px;
			border-radius: 5px;
			border: 1px solid #0d6efd;
		}
		
		.campo-item {
			margin-bottom: 10px;
			padding: 8px;
			border-bottom: 1px solid #e9ecef;
		}
		
		.campo-item:last-child {
			border-bottom: none;
		}
		
		.form-check-label {
			font-size: 0.9rem;
			margin-left: 5px;
		}
		
		.btn-toggle-all {
			margin-bottom: 15px;
		}		
		
		/*--- Estilos para la paginación ---*/
		.pagination-container {
			display: flex;
			justify-content: left;
			margin: 10px;
		}
		
		.pagination {
			margin: 10px 10px;
		}
		
		.pagination .page-link {
			border: 1px solid #757575ff !important;
		}
				
		.page-info {
			text-align: left;
			/*margin: 10px 0;*/
			font-size: 0.9rem;
			color: #6c757d;
			display: flex;
			align-items: center;
		}
		
		.loading-overlay {
			display: none;
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: rgba(255, 255, 255, 0.8);
			z-index: 1000;
			justify-content: center;
			align-items: center;
		}
		
		/*--- Estilo para campos deshabilitados ---*/
		.campo-item.text-muted .form-check-input:disabled {
			background-color: #f8f9fa;
			border-color: #3a3a3aff;
			cursor: not-allowed;
		}
		
		.campo-item.text-muted .form-check-label {
			color: #000000ff;
		}
	</style>
{% endblock %}

{% block header %}
	{% include 'top_nav.html' %}
{% endblock %}

{% block main %}
	<div id="layoutSidenav">
		<div id="layoutSidenav_nav">
			{% include 'sidebar.html' %}
		</div>
		
		<div id="layoutSidenav_content">
			<main>
				<div class="container-fluid px-4">
					<h1 class="mt-4">Previsualización del Archivo ({{proceso}})</h1>
					<ol class="breadcrumb mb-4">
						<li class="breadcrumb-item"><a href="{% url 'home' %}">Panel</a></li>
						<li class="breadcrumb-item"><a href="{% url 'cargar_excel' %}?proceso={{proceso}}">Cargar Excel</a></li>
						<li class="breadcrumb-item active">Previsualización</li>
					</ol>
					
					<!--///////////////////////////////////////////////-->
					{% if messages %}
						<div class="alert-messages">
							{% for message in messages %}
								<div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show">
									{{ message }}
									<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
								</div>
							{% endfor %}
						</div>
					{% endif %}
					<!--///////////////////////////////////////////////-->
					
					{% comment %} <div class="container-main"> {% endcomment %}
					<div class="container-main"{% if proceso == 'agregar' %} style="display: block;"{% endif %}>
						<!-- Panel izquierdo: Tabla de datos -->
						<div class="table-container">
							<div class="card mb-4">
								<div class="card-header d-flex align-items-center">
									<div class="d-flex align-items-center">
										<i class="fas fa-table me-2"></i>
										<span>Archivo: <strong>{{ nombre_archivo }}</strong></span>
										<span class="badge bg-primary badge-count ms-2">{{ total_filas }} registros</span>
									</div>
								</div>
								
								<!-- Información de paginación -->
								<div class="page-info">
									{% include 'datatools/paginacion.html' %}
									Mostrando página {{ pagina_actual }} de {{ total_paginas }} 
									(registros {{ page_start }} a {{ page_end }} de {{ total_filas }})
								</div>
								
								<div class="card-body p-0 position-relative">
									<div class="loading-overlay" id="loadingOverlay">
										<div class="spinner-border text-primary" role="status">
											<span class="visually-hidden">Cargando...</span>
										</div>
									</div>
									
									<div class="table-responsive">
										<table class="table table-fit mb-0">
											<thead>
												<tr>
													{% for columna in columnas %}
														<th>{{ columna }}</th>
													{% endfor %}
												</tr>
											</thead>
											<tbody>
												{% for fila in datos %}
													<tr>
														{% for key, valor in fila.items %}
															{% with valor_tipo=valor|get_type %}
																<td data-content="{{ valor|default:'' }}" 
																	title="{{ valor|default:'' }}"
																	{% if valor_tipo == 'float' or valor_tipo == 'Decimal' %}class="number-cell"{% endif %}>
																	{% if valor_tipo == 'float' or valor_tipo == 'Decimal' %}
																		{{ valor|formato_es_ar }}
																	{% else %}
																		{{ valor|default:'' }}
																	{% endif %}
																</td>
															{% endwith %}
														{% endfor %}
													</tr>
												{% endfor %}
											</tbody>
										</table>
									</div>
									
									<!-- Paginación -->
									{% if datos and total_paginas > 1 %}
										<div class="page-info">
											{% include 'datatools/paginacion.html' %}
											Mostrando página {{ pagina_actual }} de {{ total_paginas }} 
											(registros {{ page_start }} a {{ page_end }} de {{ total_filas }})
										</div>
									{% endif %}
							
								</div>
							</div>
						</div>
						
						<!--***********************************-->
						<!-- Panel derecho: Selección de campos -->
						{% if proceso == 'actualizar' %}
							<div class="form-container">
								<div class="card">
									<div class="card-header">
										<i class="fas fa-cogs me-1"></i>
										Campos a Actualizar
									</div>
									<div class="card-body">
										<form method="post" id="formActualizacion" action="{% url 'actualizar_productos' %}?pagina={{ pagina_actual }}">
											{% csrf_token %}
											
											<div>
												<button type="button" class="btn btn-outline-primary btn-sm btn-toggle-all w-100" onclick="toggleAllCheckboxes()">
													<i class="fas fa-check-square"></i> Seleccionar/Deseleccionar Todos
												</button>
											</div>
											
											<div class="campos-form">
												{% for field in form_campos %}
													{% with field_name=field.label %}
													<div class="form-check campo-item {% if field.field.disabled %}text-muted{% endif %}">
														{{ field }}
														<label class="form-check-label" for="{{ field.id_for_label }}">
															{{ field_name }}
															{% if field.field.disabled %}
																<small class="text-muted">(solo lectura)</small>
															{% endif %}
														</label>
													</div>
													{% endwith %}
												{% endfor %}
											</div>
											
											<div class="text-center mt-3">
												<button type="submit" class="btn btn-success w-100 mb-3">
													<i class="fas fa-sync-alt me-1"></i>
													Actualizar
												</button>
												<a href="{% url 'cargar_excel' %}?proceso={{proceso}}" class="btn btn-secondary w-100">
													<i class="fas fa-arrow-left me-1"></i>
													Volver a Cargar
												</a>
											</div>
										</form>
									</div>
								</div>
							</div>
						{% else %}
							<form method="post" id="formAgregar" action="{% url 'agregar_productos' %}?pagina={{ pagina_actual }}">
								{% csrf_token %}
								<div class="text-center">
									
									<button type="submit" class="btn btn-success">
										<i class="bi bi-database-add me-1"></i>
										Agregar
									</button>
									<a href="{% url 'cargar_excel' %}?proceso={{proceso}}" class="btn btn-secondary">
										<i class="fas fa-arrow-left me-1"></i>
										Volver a Cargar
									</a>
									
								</div>
							</form>
						{% endif %}
						<!--***********************************-->
					</div>
				</div>
			</main>
		</div>
	</div>
{% endblock main %}

{% block script %}
	<script>
		//-- Función para seleccionar/deseleccionar todos los checkboxes.
		function toggleAllCheckboxes() {
			const checkboxes = document.querySelectorAll('.form-check-input');
			const allChecked = Array.from(checkboxes).every(checkbox => checkbox.checked);
			
			checkboxes.forEach(checkbox => {
				checkbox.checked = !allChecked;
			});
		}
		
		//-- Ajustar automáticamente el ancho de las columnas.
		function adjustColumnWidths() {
			const table = document.querySelector('.table-fit');
			if (!table) return;
			
			const headers = table.querySelectorAll('th');
			const firstRow = table.querySelector('tbody tr');
			
			if (!firstRow) return;
			
			const cells = firstRow.querySelectorAll('td');
			
			headers.forEach((header, index) => {
				if (cells[index]) {
					const headerWidth = header.scrollWidth;
					const cellWidth = cells[index].scrollWidth;
					const maxWidth = Math.max(headerWidth, cellWidth) + 20;
					
					header.style.minWidth = maxWidth + 'px';
					cells[index].style.minWidth = maxWidth + 'px';
					
					const allCells = table.querySelectorAll(`tbody tr td:nth-child(${index + 1})`);
					allCells.forEach(cell => {
						cell.style.minWidth = maxWidth + 'px';
					});
				}
			});
		}
		
		//-- Inicializar cuando el DOM esté cargado.
		document.addEventListener('DOMContentLoaded', function() {
			//-- Ajustar columnas.
			setTimeout(adjustColumnWidths, 100);
			
			//-- Reajustar cuando la ventana cambie de tamaño.
			window.addEventListener('resize', adjustColumnWidths);
			
			//-- Inicializar tooltips de Bootstrap si los usas.
			var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
			var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
				return new bootstrap.Tooltip(tooltipTriggerEl);
			});
		});
	</script>
{% endblock script %}