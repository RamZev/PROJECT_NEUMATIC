{% extends 'proceso_form.html' %}

{% load static %}

{% block style %}
    body {
        background-color: rgb(0, 204, 255);
    }

    .tbl-container {
        width: 100%;
        overflow-x: auto;
    }
        
    .tbl-fixed {
        overflow-x: scroll;
        overflow-y: scroll;
        height: fit-content;
        max-height: 60vh;
        margin-top: 0px;
        font-size: 80%;
    }
    table {
        width: 100%; /* Forzar la tabla a ocupar el 100% del contenedor */
        table-layout: fixed; /* Fijar el ancho de las columnas */
    }

    table th, table td {
        overflow: hidden; /* Prevenir que el contenido haga que la tabla se expanda */
        text-overflow: ellipsis; /* Mostrar puntos suspensivos si el contenido es demasiado largo */
        white-space: nowrap; /* Prevenir que el texto se divida en varias l铆neas */
    }

    table th {
        position: sticky;
        top: 0px;
    }

    /* Additional styling for inputs */
    .table .form-control {
        width: 100%; /* Ensure input fields take full width of their columns */
    }

    .small-font {
        transform: scale(1); /* Escala todo al 80% */
        transform-origin: top left; /* Mantiene la esquina superior izquierda como punto de origen */
    }

    .detalle-form {
        width: 100%;
        table-layout: fixed; /* Asegura que las columnas se distribuyan uniformemente */
    }
    
    .detalle-form thead,
    .detalle-form tbody {
        width: 100%;
    }
    
    .detalle-form th,
    .detalle-form td {
        width: 100%;
        box-sizing: border-box; /* Para incluir padding y borders en el ancho total */
    }

    
    .readonly-select {
        background-color: #f0f0f0;
        border-color: #ccc;
        color: #555;
        cursor: not-allowed;
    }
       
    
{% endblock style %}

{% block maincomponent %}

    {% block principalcomponent %}
    <div id="layoutSidenav_content">
		<main>
            <div class="container-fluid tbl-container">
                <!-- Formulario Encabezado Detalle - Inicio -->
                <form method="post" id="factura-form">

                    {% csrf_token %}

                    <div class="accordion mt-2" id="accordionPanelsStayOpenExample">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseOne" aria-expanded="true" aria-controls="panelsStayOpen-collapseOne">
                                Comprobante de Venta
                            </button>
                            </h2>
                            <div id="panelsStayOpen-collapseOne" class="accordion-collapse collapse show">
                            <div class="accordion-body">
                                <!--  Encabezado de Factura- Inicio -->
                                <div class="row">
                                    <!-- sector izquierdo del encabezado start -->
                                    <div class="col-md-6">
                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label for="{{ form.id_sucursal.id_for_label }}">Sucursal</label>
                                            </div>
                                            
                                            <div class="col-md-5">
                                                {{ form.nombre_sucursal }}
                                                {{ form.id_sucursal }}
                                            </div>

                                            <div class="col-md-4">
                                                {{ form.punto_venta }}
                                                {{ form.id_punto_venta }}
                                            </div>
                                        </div>

                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label for="{{ form.id_deposito.id_for_label }}">Dep贸sito</label>
                                            </div>

                                            <div class="col-md-9">
                                                {{ form.id_deposito }}
                                            </div>
                                        </div>

                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label for="{{ form.id_comprobante_venta.id_for_label }}">Comprobante</label>
                                            </div>                                            
                                            
                                            <div class="col-md-9">
                                                {{ form.id_comprobante_venta }}
                                            </div>
                                        </div>

                                        <div class="row my-1">
                                            <!-- Campo de Autocompletado para Buscar Cliente -->
                                            <div class="col-md-3">
                                                <label for="{{ form.buscar_cliente.id_for_label }}">Buscar Cliente</label>
                                            </div>
                                        
                                            <div class="col-md-6">
                                                {{ form.buscar_cliente }}
                                            </div>

                                            <div class="col-md-3 d-flex justify-content-end">
                                                <button type="button" class="btn btn-outline-primary btn-sm me-2 h-75" title="Validar" id="validarBtn">
                                                    <i class="bi bi-card-checklist"></i>
                                                </button>

                                                <button type="button" class="btn btn-outline-primary btn-sm me-2 h-75" title="Listar" data-bs-toggle="modal" data-bs-target="#agendaModal">
                                                    <i class="bi bi-card-list"></i>
                                                </button>
                                                {% comment %} <button type="button" class="btn btn-outline-primary btn-sm me-2" id="listarBtn">Listar</button> {% endcomment %}
                                                
                                                <a href="{% url 'cliente_create' %}" target="_blank" title="Crear Cliente"
                                                class="btn btn-outline-primary btn-sm me-2  h-75 d-flex align-items-center text-decoration-none">
                                                    <i class="bi bi-building-add"></i>
                                                </a>
                                                
                                            </div>
                                        </div>

                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label for="{{ form.id_cliente.id_for_label }}">ID Cliente</label>
                                            </div>

                                            <div class="col-md-3">
                                                {{ form.id_cliente }}
                                            </div>

                                            <div class="col-md-2">
                                                <label for="{{ form.cuit.id_for_label }}">CUIT</label>
                                            </div>

                                            <div class="col-md-4">
                                                {{ form.cuit }}
                                            </div>
                                        </div>

                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label for="{{ form.nombre_factura.id_for_label }}">Nombre</label>
                                            </div>
                                        
                                            <div class="col-md-9">
                                                {{ form.nombre_factura }}
                                            </div>
                                        </div>

                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label for="{{ form.domicilio_factura.id_for_label }}">Domicilio</label>
                                            </div>
                                        
                                            <div class="col-md-9">
                                                {{ form.domicilio_factura }}
                                                
                                            </div>
                                        </div>
                                        
                                    </div>
                                    <!-- sector izquierdo del encabezado end -->
                                    

                                    <!-- sector derecho del encabezado start -->
                                    <div class="col-md-6">
                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label for="{{ form.fecha_comprobante.id_for_label }}">Fecha</label>
                                            </div>
                                            
                                            <div class="col-md-4">
                                                {{ form.fecha_comprobante }}
                                            </div>

                                            <div class="col-md-5">
                                                {{ form.cliente_vip }}
                                            </div>

                                        </div>
                                        
                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label for="{{ form.compro.id_for_label }}">Comprobante</label>
                                            </div>
                                            
                                            <div class="col-md-2">
                                                {{ form.compro }}

                                            </div>
                                            
                                            <div class="col-md-2">
                                                {{ form.letra_comprobante }}

                                            </div>

                                            <div class="col-md-5">
                                                {{ form.numero_comprobante }}

                                            </div>
                                        </div>

                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label for="{{ form.remito.id_for_label }}">Remito</label>
                                            </div>

                                            <div class="col-md-4">
                                                {{ form.remito }}
                                            </div>
                                        </div>
                                        
                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label for="id_vendedor_factura">Vendedor</label>
                                            </div>
                                            <div class="col-md-9">
                                                {{ form.vendedor_factura }}
                                                {{ form.id_vendedor }}
                                            </div>
                                        </div>
                                        
                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label for="{{ form.condicion_comprobante.id_for_label }}">Condici贸n</label>
                                            </div>

                                            <div class="col-md-4">
                                                {{ form.condicion_comprobante }}
                                            </div>

                                            <div class="col-md-5">
                                                {{ form.no_estadist }}
                                                <label class="form-check-label" for="{{ form.no_estadist.id_for_label }}">
                                                    No Estad铆sticas
                                                </label>
                                            </div>
                                        </div>

                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label for="{{ form.movil_factura.id_for_label }}">Tel茅fono M贸vil</label>
                                            </div>
                                        
                                            <div class="col-md-6">
                                                {{ form.movil_factura }}
                                            </div>
                                        </div>

                                        <div class="row my-1">
                                            <div class="col-md-3">
                                                <label for="{{ form.email_factura.id_for_label }}">Email</label>
                                            </div>

                                            <div class="col-md-9">
                                                {{ form.email_factura }}
                                            </div>
                                            
                                        </div>
                                        
                                    </div>
                                    <!-- sector derecho del encabezado end -->
                                </div>
                                <!--  Encabezado de Factura- Fin -->
                            </div>
                            </div>
                        </div>

                        <div class="container my-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <!-- Botones a la izquierda -->
                                <div>
                                    <button class="btn btn-outline-success btn-sm">
                                        Guardar
                                        <i class="bi bi-floppy"></i>
                                    </button>
                                    

                                    <a href="{% url 'factura_list' %}" class="btn btn-outline-secondary btn-sm me-2">
                                        Cancelar
                                        <i class="bi bi-x-circle"></i>
                                    </a>
                                </div>
                                <!-- Bot贸n a la derecha -->
                                {% comment %} <button type="button" class="btn btn-outline-primary btn-sm me-2" data-bs-toggle="modal" data-bs-target="#detalleModal" id="btnAgregarDetalle">
                                    Agregar Detalle
                                    <i class="bi bi-file-earmark-plus"></i>
                                </button> {% endcomment %}

                                <button type="button" class="btn btn-outline-primary btn-sm me-2" id="btnAgregarDetalle">
                                    Agregar Detalle
                                    <i class="bi bi-file-earmark-plus"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseTwo" aria-expanded="false" aria-controls="panelsStayOpen-collapseTwo">
                                    Detalle de Venta
                                </button>
                            </h2>
                            
                            <div id="panelsStayOpen-collapseTwo" class="accordion-collapse collapse">
                                <div class="accordion-body">
                                    
                                    
                                    <div class="row tbl-fixed my-2 mx-1" id="formset-container">
                                        {{ formset.management_form }}
                                        
                                        <table class="detalle-form table table-striped table-hover table-responsive" style="width: 100%;">
                                            <thead class="table-primary small-font">
                                                <tr>
                                                    <th style="width: 12%;">Medida</th>
                                                    <th style="width: 30%;">Nombre Producto</th>
                                                    <th style="width: 8%;">Cantidad</th>
                                                    <th style="width: 8%;">Reventa</th>
                                                    <th style="width: 12%;">Precio</th>
                                                    <th style="width: 10%;">Descuento</th>
                                                    <th style="width: 15%;">Total</th>
                                                    <th style="width: 5%;">Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {# Inicialmente no hay filas en el formulario #}
                                                {% for form in formset %}
                                                    <tr data-form-index="{{ forloop.counter0 }}">
                                                        <td>
                                                            {% if form.instance.pk %}
                                                                {{ form.id_detalle_factura }}
                                                                {{ form.id_factura }}
                                                                {% comment %} {{ form.id_producto }}     {% endcomment %}
                                                            {% endif %}
                                                            
                                                            {{ form.codigo_producto }}
                                                        </td>
                                                        <td>{{ form.nombre_producto }}</td>
                                                        <td>{{ form.unidad_producto }}</td>
                                                        <td>{{ form.cantidad }}</td>
                                                        <td>{{ form.precio_unitario }}</td>
                                                        <td>{{ form.subtotal_detalle }}</td>
                                                        <td>{{ form.descuento }}</td>
                                                        <td>{{ form.monto_igv }}</td>
                                                        <td>{{ form.total_detalle }}</td>
                                                    </tr>
                                                {% endfor %}

                                            </tbody>
                                            
                                        </table>
                                    </div>
                                    
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Card del Detalle de Factura - Inicio -->
                    
                    <!-- Card del Detalle de Factura - Fin -->

                </form>
                <!-- Formulario Encabezado Detalle - Fin -->
            </div>
        </main>
    </div>
    {% endblock principalcomponent %}

{% endblock maincomponent %}
    
{% block modals %}
    {% comment %} Ventana Modal Buscar Producto Start {% endcomment %}
    <div class="modal fade" id="detalleModal" tabindex="-1" aria-labelledby="detalleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl" style="max-width: 90%;">
            <div class="modal-content">
                <div class="modal-header text-dark bg-primary bg-opacity-25 py-2">
                    <h5 class="modal-title fs-6" id="detalleModalLabel">Productos**</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Formulario modal -->
                    <form method="post" id="detalleForm">
                        {% csrf_token %}
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <input type="text" class="form-control form-control-sm border border-primary" id="medida_producto" placeholder="Medida Producto">
                            </div>
                            <div class="col-md-4">
                                <input type="text" class="form-control form-control-sm border border-primary" id="nombre_producto" placeholder="Nombre Producto">
                            </div>
                            <div class="col-md-3">
                                <input type="text" class="form-control form-control-sm border border-primary" id="cai_producto" placeholder="CAI Producto">
                            </div>
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-outline-primary btn-sm me-2">
                                    Buscar
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-responsive tbl-fixed">
                            <table class="table table-striped small-text" id="tabla-resultados">
                                <thead class="table-primary fs-7">
                                    <tr>
                                        <th style="width: 12%;">Marca</th>
                                        <th style="width: 12%;">Medida</th>
                                        <th style="width: 34%;">Nombre</th>
                                        <th style="width: 10%;">Precio</th>
                                        <th style="width: 8%;">Stock</th>
                                        <th style="width: 8%;">M铆nimo</th>
                                        <th style="width: 8%;">Estatus</th>
                                        <th style="width: 8%;">...</th>
                                    </tr>
                                </thead>

                                <tbody>
                                </tbody>
                            </table>
                        </div>
                        <!-- Botones del formulario -->
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline-primary btn-sm me-2" id="agregarDetalle">Insertar</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal" id="cancelarDetalle">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% comment %} Ventana Modal Buscar Producto End {% endcomment %}


    <!-- Modal para Listar Agenda-->
    <div class="modal fade" id="agendaModal" tabindex="-1" aria-labelledby="agendaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg" style="max-width: 90%;">
            <div class="modal-content">
                <div class="modal-header text-dark bg-primary bg-opacity-25 py-2">
                    <h5 class="modal-title fs-6" id="agendaModalLabel">Buscar en Agenda</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Formulario modal -->
                    <form method="post" id="buscarAgendaForm">
                        {% csrf_token %}
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <input type="text" class="form-control form-control-sm border border-primary" id="busquedaGeneral" placeholder="Buscar por id o nombre">
                            </div>
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-outline-primary btn-sm me-2">
                                    Buscar
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-responsive tbl-fixed">
                            <table class="table table-striped small-text" id="tablaResultadosAgenda">
                                <thead class="table-primary fs-7">
                                    <tr>
                                        <th scope="col" style="width: 10%;">ID Cliente</th>
                                        <th scope="col" style="width: 12%;">CUIT</th>
                                        <th scope="col" style="width: 25%;">Nombre</th>
                                        <th scope="col" style="width: 15%;">M贸vil</th> <!-- Agregado -->
                                        <th scope="col" style="width: 20%;">Email</th> <!-- Agregado -->
                                        <th scope="col" style="width: 20%;">Direcci贸n</th>
                                        <th scope="col" style="width: 8%;">C贸digo Postal</th>
                                        <th scope="col" style="width: 5%;">Seleccionar</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                        <!-- Botones del formulario -->
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline-primary btn-sm me-2" id="seleccionarAgenda">
                                Seleccionar
                                <i class="bi bi-check2-circle"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal" id="cancelarAgenda">
                                Cancelar
                                <i class="bi bi-x-circle"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Crear Agenda -->
    <div class="modal fade" id="crearAgendaModal" tabindex="-1" aria-labelledby="crearAgendaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl" style="max-width: 70%;">
            <div class="modal-content">
                <div class="modal-header text-dark bg-primary bg-opacity-25 py-2">
                    <h5 class="modal-title fs-6" id="crearAgendaModalLabel">Crear Nueva Agenda</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Formulario para crear un nuevo registro -->
                    
                </div>
            </div>
        </div>
    </div>

{% endblock modals %}

{% block script %}
    {% comment %} SCRIPTS JS Start {% endcomment %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const formsetContainer = document.getElementById('formset-container');
    
            // Agregar fila de total general al final del tfoot
            const tfootHTML = `
            <tfoot>
                <tr>
                    <td colspan="6" class="text-end"><strong>Total Factura:</strong></td>
                    <td>
                        <input type="number" id="total-factura" class="form-control form-control-sm text-end" value="0.00" readonly>
                    </td>
                    <td></td>
                </tr>
            </tfoot>
            `;
            formsetContainer.querySelector('.detalle-form').insertAdjacentHTML('beforeend', tfootHTML);
    
            // Funci贸n para actualizar el total general
            function actualizarTotalFactura() {
                let totalFactura = 0;
                formsetContainer.querySelectorAll('.detalle-form tbody tr').forEach(row => {
                    const total = parseFloat(row.querySelector('[name*="-total"]').value) || 0;
                    totalFactura += total;
                });
    
                // Actualizar el campo total general
                const totalFacturaInput = document.getElementById('total-factura');
                totalFacturaInput.value = totalFactura.toFixed(2);
            }
    
            // Recalcular total general din谩micamente
            formsetContainer.addEventListener('input', function (event) {
                if (['cantidad', 'precio', 'descuento'].some(field => event.target.name.includes(field))) {
                    const row = event.target.closest('tr');
                    const cantidad = parseFloat(row.querySelector('[name*="-cantidad"]').value) || 0;
                    const precio = parseFloat(row.querySelector('[name*="-precio"]').value) || 0;
                    const descuento = parseFloat(row.querySelector('[name*="-descuento"]').value) || 0;
                    const totalField = row.querySelector('[name*="-total"]');
    
                    // Recalcular total por fila
                    const total = (cantidad * precio) - descuento;
                    totalField.value = total.toFixed(2);
    
                    // Actualizar el total general
                    actualizarTotalFactura();
                }
            });
    
            // Actualizar el total general cuando se elimina una fila
            formsetContainer.addEventListener('click', function (event) {
                if (event.target.classList.contains('btn-delete')) {
                    const row = event.target.closest('tr');
                    row.remove(); // Elimina la fila
                    actualizarTotalFactura(); // Recalcula el total general
                }
            });
        });
    </script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const buscarProductoForm = document.getElementById('detalleForm');
            const tablaResultados = document.querySelector('#tabla-resultados tbody');
            const detalleModal = document.getElementById('detalleModal');
            const formsetContainer = document.getElementById('formset-container');
            const insertarBtn = document.getElementById('agregarDetalle');
            
            // Almacenar los productos seleccionados temporalmente
            let productosSeleccionados = [];

            // Clase reutilizable
            const formControlClass = 'form-control form-control-sm border border-primary small-font';

            // Evento para seleccionar productos
            tablaResultados.addEventListener('change', function(event) {
                if (event.target.matches('.seleccionar-producto')) {
                    const isChecked = event.target.checked;
                    const row = event.target.closest('tr');
                    const idProducto = event.target.dataset.idProducto; // Capturar ID del producto
                    const medidaProducto = row.querySelector('td:nth-child(2)').textContent.trim();
                    const nombreProducto = row.querySelector('td:nth-child(3)').textContent.trim();
                    const precioProducto = parseFloat(row.querySelector('td:nth-child(4)').textContent.trim());

                    const producto = {
                        idProducto,
                        medida: medidaProducto,
                        nombre: nombreProducto,
                        precio: precioProducto,
                    };

                    if (isChecked) {
                        productosSeleccionados.push(producto);
                    } else {
                        productosSeleccionados = productosSeleccionados.filter(p => p.idProducto !== idProducto);
                    }
                }
            });

            // Manejar el bot贸n de insertar
            insertarBtn.addEventListener('click', function() {
                productosSeleccionados.forEach(producto => {
                    const currentIndex = formsetContainer.querySelectorAll('.detalle-form tbody tr').length;

                    // console.log("currentIndex", currentIndex);
                    // console.log("insertando****");

                    const newFormHTML = `
                    <tr data-form-index="${currentIndex}" class="small-font">
                        <td>${producto.medida}</td> <!-- Mostrar medida -->
                        <td>${producto.nombre}</td> <!-- Mostrar nombre -->
                        <td>
                            <input type="number" name="detallefactura_set-${currentIndex}-cantidad" 
                                class="${formControlClass} text-end" value="1" min="1" step="1" required>
                        </td>
                        <td>
                            <input type="text" name="detallefactura_set-${currentIndex}-reventa" 
                                class="${formControlClass}" value="M" required>
                        </td>
                        <td>
                            <input type="number" name="detallefactura_set-${currentIndex}-precio" 
                                class="${formControlClass} text-end" value="${producto.precio}" step="0.01" required>
                        </td>
                        <td>
                            <input type="number" name="detallefactura_set-${currentIndex}-descuento" 
                                class="${formControlClass} text-end" value="0" step="0.01" required>
                        </td>
                        <td>
                            <input type="number" name="detallefactura_set-${currentIndex}-total" 
                                class="${formControlClass} text-end" value="${producto.precio}" readonly>
                        </td>
                        <td>
                            <button type="button" class="btn btn-danger btn-sm btn-delete" data-form-index="${currentIndex}">Eliminar</button>
                        </td>
                    </tr>
                    `;

                    // Agregar la nueva fila al cuerpo de la tabla
                    formsetContainer.querySelector('.detalle-form tbody').insertAdjacentHTML('beforeend', newFormHTML);
                    
                    // Actualizar el valor de TOTAL_FORMS
                    const totalFormsInput = document.querySelector('[name$="TOTAL_FORMS"]');
                    totalFormsInput.value = formsetContainer.querySelectorAll('.detalle-form tbody tr').length;

                    //console.log("totalFormsInput.value", totalFormsInput.value);

                });

                // Aqu铆 es
                // Limpiar productos seleccionados y cerrar la ventana modal
                productosSeleccionados = [];
                detalleModal.querySelector('.btn-close').click();
            });

            // Recalcular total din谩micamente
            formsetContainer.addEventListener('input', function (event) {
                if (['cantidad', 'precio', 'descuento'].some(field => event.target.name.includes(field))) {
                    const row = event.target.closest('tr');
                    const cantidad = parseFloat(row.querySelector('[name*="-cantidad"]').value) || 0;
                    const precio = parseFloat(row.querySelector('[name*="-precio"]').value) || 0;
                    const descuento = parseFloat(row.querySelector('[name*="-descuento"]').value) || 0;
                    const totalField = row.querySelector('[name*="-total"]');

                    const total = (cantidad * precio) - descuento;
                    totalField.value = total.toFixed(2);
                }
            });

            // Limpiar filtros y resultados cuando se cierra la ventana modal
            detalleModal.addEventListener('hidden.bs.modal', function () {
                buscarProductoForm.reset(); // Restablecer el formulario
                tablaResultados.innerHTML = ''; // Limpiar la tabla de resultados
                productosSeleccionados = []; // Limpiar la lista de productos seleccionados
            });

            // Manejar el submit del formulario de b煤squeda de producto
            buscarProductoForm.addEventListener('submit', function (event) {
                event.preventDefault();

                const medidaProducto = document.getElementById('medida_producto').value;
                const nombreProducto = document.getElementById('nombre_producto').value;
                const caiProducto = document.getElementById('cai_producto').value;

                fetch(`/ventas/buscar/producto/?medida=${medidaProducto}&nombre=${nombreProducto}&cai=${caiProducto}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                })
                .then(response => response.json())
                .then(data => {
                    tablaResultados.innerHTML = ''; // Limpiar tabla de resultados

                    const formateadorPrecio = new Intl.NumberFormat('es-ES', {
                        style: 'decimal',
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2,
                    });
                    
                    data.forEach(producto => {
                        const precioFormateado = formateadorPrecio.format(producto.precio);
                        
                        const fila = `
                            <tr>
                                <td>${producto.marca}</td>
                                <td>${producto.medida}</td>
                                <td>${producto.nombre}</td>
                                <td class="text-end"><strong>${precioFormateado}</strong></td>
                                <td class="text-end">${producto.stock}</td>
                                <td class="text-end">${producto.minimo}</td>
                                <td>${producto.estatus}</td>
                                <td>
                                    <input type="checkbox" class="seleccionar-producto" 
                                           data-codigo="${producto.codigo}" 
                                           data-nombre="${producto.nombre}" 
                                           data-precio="${producto.precio}">
                                </td>
                            </tr>
                        `;
                        tablaResultados.insertAdjacentHTML('beforeend', fila);
                    });
                })
                .catch(error => {
                    console.error('Error al buscar productos:', error);
                });
            });

        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('validarBtn').addEventListener('click', function() {
                const nroDocIdentidad = document.getElementById('id_cuit').value;

                console.log("Entr贸 al script");
                alert(nroDocIdentidad);
                console.log(nroDocIdentidad);
            
                fetch('/ventas/validar/documento/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')  // Aseg煤rate de incluir el token CSRF si es necesario
                    },
                    body: JSON.stringify({ nro_doc_identidad: nroDocIdentidad })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.exists) {
                        // Asignar los valores a los inputs correspondientes
                        alert("Encontrado ojo!!!")
                        document.getElementById('id_nombre_factura').value = data.nombre_receptor || '';
                        document.getElementById('id_domicilio_factura').value = data.domicilio_receptor || '';
                    } else {
                        alert('El documento no existe.');
                    }
                })
                .catch(error => console.error('Error:', error));
            });
        
            // Funci贸n para obtener el token CSRF del cookie
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
        });
        
    </script>
    {% comment %} SCRIPTS JS End {% endcomment %}

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const buscarAgendaForm = document.getElementById('buscarAgendaForm');
            const tablaResultadosAgenda = document.getElementById('tablaResultadosAgenda').querySelector('tbody');
        
            // alert("capturando el submit de buscarAgendaForm")
            
            buscarAgendaForm.addEventListener('submit', function (event) {
                event.preventDefault();
        
                const busquedaGeneral = document.getElementById('busquedaGeneral').value;

                // Validar que la b煤squeda tenga al menos 4 caracteres
                if (busquedaGeneral.length < 4) {
                    alert('Por favor, ingrese al menos 4 caracteres para realizar la b煤squeda.');
                    return;
                }
        
                const url = `/ventas/buscar/agenda/?busqueda_general=${busquedaGeneral}`;

                fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                })
                .then(response => response.json())
                .then(data => {
                    tablaResultadosAgenda.innerHTML = ''; // Limpiar tabla de resultados
        
                    data.forEach(agenda => {

                        const fila = `
                            <tr>
                                <td>${agenda.id_cliente}</td>
                                <td>${agenda.cuit}</td>
                                <td>${agenda.nombre_cliente}</td>
                                <td>${agenda.movil_cliente || 'N/A'}</td>  <!-- Muestra M贸vil -->
                                <td>${agenda.email_cliente || 'N/A'}</td>  <!-- Muestra Email -->
                                <td>${agenda.domicilio_cliente}</td>
                                <td>${agenda.codigo_postal}</td>
                                <td>
                                    <input type="radio" name="seleccionar-agenda" 
                                        class="seleccionar-agenda" 
                                        data-id="${agenda.id_cliente}" 
                                        data-cuit="${agenda.cuit}" 
                                        data-nombre="${agenda.nombre_cliente}" 
                                        data-direccion="${agenda.domicilio_cliente}" 
                                        data-movil="${agenda.movil_cliente}"  
                                        data-email="${agenda.email_cliente}"
                                        data-id_vendedor="${agenda.id_vendedor}"
                                        data-nombre_vendedor="${agenda.id_vendedor__nombre_vendedor}"
                                        data-id_sucursal="${agenda.id_sucursal}" 
                                        data-vip="${agenda.vip}"  
                                        data-mayorista="${agenda.mayorista}"  
                                        data-sub_cuenta="${agenda.sub_cuenta}"  
                                        data-observaciones="${agenda.observaciones_cliente}"  
                                        data-black_list="${agenda.black_list}"  
                                        data-black_list_motivo="${agenda.black_list_motivo}">
                                </td>
                            </tr>
                        `;
                        
                        // console.log("Fila insertada:", fila);  //  Verifica si data-email est谩 en el HTML
                        tablaResultadosAgenda.insertAdjacentHTML('beforeend', fila);
                    });
                    
                })
                .catch(error => {
                    console.error('Error al buscar en agenda:', error);
                });
            });
        
            // Bot贸n seleccionar de Lista de Clientes
            document.getElementById('seleccionarAgenda').addEventListener('click', function () {
                const seleccion = document.querySelector('input[name="seleccionar-agenda"]:checked');

                if (seleccion) {
                    const id_cliente = seleccion.getAttribute('data-id');
                    const cuit = seleccion.getAttribute('data-cuit');
                    const nombre = seleccion.getAttribute('data-nombre');
                    const direccion = seleccion.getAttribute('data-direccion');
                    const movil = seleccion.getAttribute('data-movil');
                    const email = seleccion.getAttribute('data-email');
                    const id_vendedor = seleccion.getAttribute('data-id_vendedor');
                    const nombre_vendedor = seleccion.getAttribute('data-nombre_vendedor');
                    const id_sucursal_cliente = seleccion.getAttribute('data-id_sucursal');
                    // Genera un booleano sin es string
                    const vip = seleccion.getAttribute('data-vip') === 'true';
                    // const vip = seleccion.getAttribute('data-vip')
                    //const mayorista = seleccion.getAttribute('data-mayorista');
                    //const sub_cuenta = seleccion.getAttribute('data-sub_cuenta');
                    //const observaciones = seleccion.getAttribute('data-observaciones');
                    //const black_list = seleccion.getAttribute('data-black_list');
                    //const black_list_motivo = seleccion.getAttribute('data-black_list_motivo');;
                    

                    document.getElementById('id_id_cliente').value = id_cliente || '';
                    document.getElementById('id_nombre_factura').value = nombre || '';
                    document.getElementById('id_domicilio_factura').value = direccion || '';
                    document.getElementById('id_cuit').value = cuit || '';
                    document.getElementById('id_movil_factura').value = movil || '';
                    document.getElementById('id_email_factura').value = email || '';
                    document.getElementById('id_id_vendedor').value = id_vendedor || '';
                    document.getElementById('id_vendedor_factura').value = nombre_vendedor || '';

                    
                    
                    const id_sucursal_factura = document.getElementById('id_id_sucursal').value;
                    //alert(`id_sucursal_factura ${id_sucursal_factura}`);
                    //alert(`id_sucursal_cliente ${id_sucursal_cliente}`);

                    if (id_sucursal_cliente !== id_sucursal_factura) {
                        alert('Atenci贸n: El cliente pertenece a otra sucursal.');
                    }

                    if (vip) {
                        alert("锔 Este es un Cliente VIP - Trato Especial 锔");
                        document.getElementById('id_cliente_vip').value = "Cliente VIP" 
                    }

                    /////////////////

                    //document.getElementById('id_id_sucursal').value = id_sucursal || '';
                    //document.getElementById('id_vip').value = vip === 'true' ? 'S铆' : 'No';
                    //document.getElementById('id_mayorista').value = mayorista === 'true' ? 'S铆' : 'No';
                    //document.getElementById('id_sub_cuenta').value = sub_cuenta || '';
                    //document.getElementById('id_observaciones').value = observaciones || '';
                    //document.getElementById('id_black_list').value = black_list === 'true' ? 'S铆' : 'No';
                    //document.getElementById('id_black_list_motivo').value = black_list_motivo || '';
                    
                    // Cerrar el modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('agendaModal'));
                    modal.hide();
                }
            });

            // Limpiar filtros y resultados cuando se cierra la ventana modal
            agendaModal.addEventListener('hidden.bs.modal', function () {
                buscarAgendaForm.reset(); // Restablecer el formulario
                tablaResultadosAgenda.innerHTML = ''; // Limpiar la tabla de resultados
            });
        });

        
    </script>

    {% comment %} Script para crear un registro de Agenda {% endcomment %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const crearAgendaModal = new bootstrap.Modal(document.getElementById('crearAgendaModal'));
            const crearAgendaForm = document.getElementById('crearAgendaForm');
    
            // Manejo del bot贸n 'Crear'
            document.getElementById('guardarAgenda').addEventListener('click', function () {
                // Disparar el evento submit del formulario
                crearAgendaForm.dispatchEvent(new Event('submit'));
            });
    
            // Manejo del formulario 'Crear Agenda'
            crearAgendaForm.addEventListener('submit', function (event) {
                event.preventDefault();
    
                const tipoDoc = document.getElementById('tipoDoc').value;
                const nroDocIdentidad = document.getElementById('nroDocIdentidad').value;
                const nombreAgenda = document.getElementById('nombreAgenda').value;
                const direccion = document.getElementById('direccion').value;
                const e_mail1 = document.getElementById('email_1').value;
                const telefono1 = document.getElementById('telefono1').value;

                if (!tipoDoc) {
                    alert('El campo Tipo de Documento es obligatorio.');
                    document.getElementById('tipoDoc').focus();
                    event.preventDefault();
                    return;
                }
            
                if (!nroDocIdentidad) {
                    alert('El campo N煤mero de Documento es obligatorio.');
                    document.getElementById('nroDocIdentidad').focus();
                    event.preventDefault();
                    return;
                }
            
                if (!nombreAgenda) {
                    alert('El campo Nombre es obligatorio.');
                    document.getElementById('nombreAgenda').focus();
                    event.preventDefault();
                    return;
                }
            
                if (!direccion) {
                    alert('El campo Direcci贸n es obligatorio.');
                    document.getElementById('direccion').focus();
                    event.preventDefault();
                    return;
                }
            
                if (!e_mail1) {
                    alert('El campo Email es obligatorio.');
                    document.getElementById('email_1').focus();
                    event.preventDefault();
                    return;
                }
            
                if (!telefono1) {
                    alert('El campo Tel茅fono es obligatorio.');
                    document.getElementById('telefono1').focus();
                    event.preventDefault();
                    return;
                }
    
                fetch('/ventas/crear/agenda/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        codigo_tipodoc_identidad: tipoDoc,
                        nro_doc_identidad: nroDocIdentidad,
                        nombre_agenda: nombreAgenda,
                        direccion: direccion,
                        email_1: email_1,
                        telefono1: telefono1
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Agenda creada con 茅xito');
                        crearAgendaModal.hide();
                        
                        // Actualizar los campos en la plantilla principal
                        document.querySelector('input[name="nro_doc_identidad"]').value = nroDocIdentidad;
                        document.querySelector('input[name="nombre_receptor"]').value = nombreAgenda;
                        document.querySelector('input[name="direccion_receptor"]').value = direccion;
                        document.querySelector('input[name="email_receptor"]').value = email1;
                        document.querySelector('input[name="telefono_receptor"]').value = telefono1;
                        
                    } else {
                        alert('Error al crear la agenda');
                    }
                })
                .catch(error => {
                    console.error('Error al crear la agenda:', error);
                });
            });
    
            // Limpiar el formulario cuando se cierra el modal
            document.getElementById('crearAgendaModal').addEventListener('hidden.bs.modal', function () {
                crearAgendaForm.reset();
            });
        });
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const depositoSelect = document.getElementById("id_deposito_select");
            const depositoHidden = document.getElementById("id_id_deposito");  // Campo oculto
    
            // Sincronizar el valor del campo oculto con el select visible
            depositoSelect.addEventListener("change", function () {
                // Asignar el valor seleccionado al campo oculto
                depositoHidden.value = depositoSelect.value;
    
                // Deshabilitar el select despu茅s de la selecci贸n
                depositoSelect.disabled = true;
            });
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Funci贸n para aplicar la l贸gica de solo lectura a un campo select
            function makeSelectReadOnly(selectElement) {
                // Guarda el valor inicial seleccionado
                var initialValue = selectElement.value;
        
                // Deshabilita la interacci贸n despu茅s de la primera selecci贸n
                selectElement.addEventListener('change', function() {
                    // Deshabilita todas las opciones excepto la seleccionada
                    Array.from(selectElement.options).forEach(function(option) {
                        if (option.value !== selectElement.value) {
                            option.disabled = true;
                        }
                    });
        
                    // Aplica un estilo visual para indicar que es de solo lectura
                    selectElement.classList.add('readonly-select');
                });
        
                // Si ya hay un valor seleccionado al cargar la p谩gina, deshabilita las otras opciones
                if (selectElement.value) {
                    Array.from(selectElement.options).forEach(function(option) {
                        if (option.value !== selectElement.value) {
                            option.disabled = true;
                        }
                    });
                    selectElement.classList.add('readonly-select');
                }
            }
        
            // Aplicar la l贸gica a id_deposito
            var selectDeposito = document.getElementById('id_id_deposito');
            if (selectDeposito) {
                makeSelectReadOnly(selectDeposito);
            }
        
            // Aplicar la l贸gica a id_comprobante_venta
            var selectComprobante = document.getElementById('id_id_comprobante_venta');
            if (selectComprobante) {
                makeSelectReadOnly(selectComprobante);
            }
            
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Funci贸n para aplicar la l贸gica de solo lectura a un campo select
            function makeSelectReadOnly(selectElement) {
                // Guarda el valor inicial seleccionado
                var initialValue = selectElement.value;
        
                // Deshabilita la interacci贸n despu茅s de la primera selecci贸n
                selectElement.addEventListener('change', function() {
                    // Deshabilita todas las opciones excepto la seleccionada
                    Array.from(selectElement.options).forEach(function(option) {
                        if (option.value !== selectElement.value) {
                            option.disabled = true;
                        }
                    });
        
                    // Aplica un estilo visual para indicar que es de solo lectura
                    selectElement.classList.add('readonly-select');
                });
        
                // Si ya hay un valor seleccionado al cargar la p谩gina, pero no es el valor por defecto, deshabilita las otras opciones
                if (selectElement.value && selectElement.value !== selectElement.options[0].value) {
                    Array.from(selectElement.options).forEach(function(option) {
                        if (option.value !== selectElement.value) {
                            option.disabled = true;
                        }
                    });
                    selectElement.classList.add('readonly-select');
                }
            }
        
            // Aplicar la l贸gica a condicion_comprobante
            var selectCondicionComprobante = document.getElementById('id_condicion_comprobante');
            if (selectCondicionComprobante) {
                makeSelectReadOnly(selectCondicionComprobante);
            }
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Bot贸n de "Listar" que abre la ventana modal
            const listarBtn = document.querySelector('[data-bs-target="#agendaModal"]');
            
            // Evento cuando se hace clic en "Seleccionar" en la ventana modal de agenda
            document.getElementById('seleccionarAgenda').addEventListener('click', function () {
                const seleccion = document.querySelector('input[name="seleccionar-agenda"]:checked');
                if (seleccion) {
                    // Deshabilitar el bot贸n "Listar"
                    listarBtn.disabled = true;
                }
            });
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('btnAgregarDetalle').addEventListener('click', function (event) {
                // Lista de IDs de los campos obligatorios
                const requiredFields = [
                    'id_id_deposito', 'id_id_comprobante_venta', 'id_id_cliente', 
                    'id_fecha_comprobante', 'id_condicion_comprobante', 
                    'id_movil_factura', 'id_email_factura'
                ];
        
                let isValid = true;
                let missingFields = [];
        
                // Validar cada campo obligatorio
                requiredFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (!field || !field.value.trim()) {
                        isValid = false;
                        missingFields.push(fieldId);
                    }
                });
        
                // Si hay campos faltantes, mostrar alerta y evitar abrir el modal
                if (!isValid) {
                    event.preventDefault();  // Evita cualquier acci贸n por defecto
                    event.stopPropagation(); // Detiene la propagaci贸n del evento
        
                    alert("锔 Debes completar todos los datos obligatorios antes de agregar un detalle.\n\nFaltan los siguientes campos:\n- " + missingFields.join("\n- "));
                    return false; // Detiene la ejecuci贸n del c贸digo
                }
        
                // Si pasa la validaci贸n, abrir el modal manualmente
                const detalleModal = new bootstrap.Modal(document.getElementById('detalleModal'));
                detalleModal.show();
            });
        });
    </script>
{% endblock script %}
